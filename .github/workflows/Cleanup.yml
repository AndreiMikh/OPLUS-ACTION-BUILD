  name: Cleanup Old Workflow Runs

  on:
    workflow_dispatch:
      inputs:
        keep_last:
          description: "Number of Recent Workflow Runs to Keep (Older Runs Will be Deleted)"
          required: false
          default: 5
        older_than_days:
          description: "Delete Workflow Runs Older than this many Days (Ignored if Empty)"
          required: false
          default: ""

  jobs:
    cleanup:
      runs-on: ubuntu-latest
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      steps:

      - name: Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install -y gh jq

      - name: List and Delete Old Workflow Runs
        run: |
          REPO="${{ github.repository }}"
          KEEP_LAST="${{ github.event.inputs.keep_last }}"
          OLDER_THAN_DAYS="${{ github.event.inputs.older_than_days }}"

          echo "Cleaning workflow runs for repo: $REPO"
          echo "Keeping last $KEEP_LAST runs"
          [[ -n "$OLDER_THAN_DAYS" ]] && echo "Deleting runs older than $OLDER_THAN_DAYS days"

          # Get all workflow runs
          gh api repos/$REPO/actions/runs --paginate \
            -q ".workflow_runs | sort_by(.created_at) | reverse | .[]" \
            | jq -c '. | {id:.id, name:.name, created_at:.created_at}' \
            | while read -r run; do
                RUN_ID=$(echo "$run" | jq -r '.id')
                CREATED_AT=$(echo "$run" | jq -r '.created_at')
                NAME=$(echo "$run" | jq -r '.name')

                DELETE=false

                RUN_POSITION=$(gh api repos/$REPO/actions/runs --paginate \
                  -q ".workflow_runs | map(.id) | index($RUN_ID)" )
                if [[ "$RUN_POSITION" -ge "$KEEP_LAST" ]]; then
                  DELETE=true
                fi

                if [[ -n "$OLDER_THAN_DAYS" ]]; then
                  CUT_OFF_DATE=$(date -d "-${OLDER_THAN_DAYS} days" --iso-8601=seconds)
                  if [[ "$CREATED_AT" < "$CUT_OFF_DATE" ]]; then
                    DELETE=true
                  fi
                fi

                if [[ "$DELETE" == true ]]; then
                  echo "Deleting workflow run: $NAME ($RUN_ID) created at $CREATED_AT"
                  gh api -X DELETE repos/$REPO/actions/runs/$RUN_ID
                else
                  echo "Keeping workflow run: $NAME ($RUN_ID) created at $CREATED_AT"
                fi
              done
