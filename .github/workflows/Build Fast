      - name: Build Kernel (Fast)
        if: ${{ github.event.inputs.FAST_BUILD == 'true' }}
        id: fast_build
        run: |
          set -euo pipefail

          KERNEL_VERSION="${{ env.KERNEL_VERSION }}"
          cd kernel_workspace/kernel_platform

          echo ">> Checking required tools"
          command -v clang >/dev/null 2>&1 || { echo "clang not found"; exit 1; }
          command -v ccache >/dev/null 2>&1 || { echo "ccache not found"; exit 1; }
          command -v ld.lld >/dev/null 2>&1 || { echo "ld.lld not found"; exit 1; }
          command -v pahole >/dev/null 2>&1 || { echo "pahole not found"; exit 1; }

          # LLVM IAS Detection 
          USE_LLVM_IAS=false
          if [[ -f ./common/build.config.arm ]] && grep -q '^LLVM_IAS=1' ./common/build.config.arm; then
            USE_LLVM_IAS=true
          fi

          # Detect Clang Prebuilt Bin 
          CLANG_PREBUILT_BIN=""
          for f in ./common/build.config.common ./"$PATH_2"/build.config.common; do
            [[ -f "$f" ]] || continue
            CLANG_PREBUILT_BIN=$(grep '^CLANG_PREBUILT_BIN=' "$f" | cut -d'=' -f2)
            [[ -n "$CLANG_PREBUILT_BIN" ]] && break
          done

          if [[ -z "$CLANG_PREBUILT_BIN" ]]; then
            echo "⚠️ Clang Prebuilt Bin not found. Falling back."
            echo "fallback=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # --- Extract Clang Version ---
          if [[ "$CLANG_PREBUILT_BIN" =~ (clang-r[0-9a-z]+) ]]; then
            CLANG_VERSION="${BASH_REMATCH[1]}"
          elif [[ -f ./common/build.config.constants ]]; then
            CLANG_VERSION=$(grep '^CLANG_VERSION=' ./common/build.config.constants | cut -d'=' -f2 || true)
          fi

          if [[ -z "$CLANG_VERSION" ]]; then
            echo "⚠️ Unable to obtain Clang version. Falling back."
            echo "fallback=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          CLANG_PREBUILT_BIN=${CLANG_PREBUILT_BIN/\$\{CLANG_VERSION\}/$CLANG_VERSION}

          echo "CLANG_VERSION=$CLANG_VERSION"
          echo "USE_LLVM_IAS=$USE_LLVM_IAS"

          # Source Environment Safely 
          set +u
          source "$GITHUB_WORKSPACE/kernel_workspace/kernel_platform/build/kernel/_setup_env.sh" 2>/dev/null || true
          set -u

          export PATH="$GITHUB_WORKSPACE/kernel_workspace/kernel_platform/$CLANG_PREBUILT_BIN:$PATH"
          export PATH="/usr/lib/ccache:$PATH"

          [[ "$ENABLE_RUST" == "true" ]] && export LIBCLANG_PATH="$GITHUB_WORKSPACE/kernel_workspace/kernel_platform/$(dirname "$CLANG_PREBUILT_BIN")/lib"

          cd ./common

          # Remap Physical Paths
          MAP="-fdebug-prefix-map=${GITHUB_WORKSPACE}=."
          MPMAP="-fmacro-prefix-map=${GITHUB_WORKSPACE}=."
          FPMAP="-ffile-prefix-map=${GITHUB_WORKSPACE}=."

          MAKE_ARGS=(
            LLVM=1
            ARCH=arm64
            CROSS_COMPILE=aarch64-linux-gnu-
            CC="ccache clang"
            HOSTCC="ccache clang"
            LD=ld.lld
            HOSTLD=ld.lld
            PAHOLE=../../prebuilts/kernel-build-tools/linux-x86/bin/pahole
            KCFLAGS+="$MAP $MPMAP $FPMAP"
            KCFLAGS+=-Wno-error
            KCFLAGS+=-D__ANDROID_COMMON_KERNEL__
          )

          [[ "$USE_LLVM_IAS" == "true" ]] && MAKE_ARGS=(LLVM_IAS=1 "${MAKE_ARGS[@]}")
          [[ "$ENABLE_RUST" == "true" ]] && MAKE_ARGS=(RUSTC=../../prebuilts/rust/linux-x86/$RUSTC_VERSION/bin/rustc "${MAKE_ARGS[@]}")

          # Ensure Output Directory Exists to Fix HDRINST Errors
          mkdir -p ../kernel_platform/common/out/include/asm

          # Configure Kernel
          make O=out "${MAKE_ARGS[@]}" gki_defconfig

          # LTO Setup
          if [[ "$KERNEL_VERSION" == "5.10" || "$KERNEL_VERSION" == "5.15" ]]; then
            scripts/config --file out/.config -e LTO_CLANG
            scripts/config --file out/.config -e LTO_CLANG_THIN
            scripts/config --file out/.config -d LTO_CLANG_NONE
            scripts/config --file out/.config -d LTO_CLANG_FULL
          elif [[ "$KERNEL_VERSION" == "6.12" ]]; then
            scripts/config --file out/.config -e LTO_CLANG
            scripts/config --file out/.config -e LTO_CLANG_NONE
            scripts/config --file out/.config -d LTO_CLANG_THIN
            scripts/config --file out/.config -d LTO_CLANG_FULL
          fi

          make O=out "${MAKE_ARGS[@]}" olddefconfig
          make -j"$(nproc)" O=out "${MAKE_ARGS[@]}" || {
            echo "❌ Kernel Build Failed, Check HDRINST or Missing Headers"
            exit 2
          }

          ccache -s

      - name: Fallback to Build Kernel (Fixed)
        if: ${{ github.event.inputs.FAST_BUILD == 'false' || steps.fast_build.outputs.fallback == 'true' }}
        run: |
          set -euo pipefail

          cd kernel_workspace

          echo ">> Ensuring Output/Include Directories Exist to Fix HDRINST"
          mkdir -p kernel_platform/common/out/include/asm

          if [ -f ./kernel_platform/build_with_bazel.py ]; then
            echo ">> Using Bazel Build Method"
            ./kernel_platform/oplus/bazel/oplus_modules_variant.sh ${{ env.CPUD }} ${{ env.BUILD_METHOD }}
            ./kernel_platform/build_with_bazel.py -t ${{ env.CPUD }} ${{ env.BUILD_METHOD }} || {
              echo "❌ Bazel Kernel Build Failed"
              exit 2
            }
          else
            echo ">> Using Traditional OPlus Build Script"
            LTO=thin SYSTEM_DLKM_RE_SIGN=0 BUILD_SYSTEM_DLKM=0 KMI_SYMBOL_LIST_STRICT_MODE=0 \
            ./kernel_platform/oplus/build/oplus_build_kernel.sh ${{ env.CPUD }} ${{ env.BUILD_METHOD }} || {
              echo "❌ Fallback Kernel Build Failed"
              exit 2
            }
          fi

          echo "✅ Fallback Kernel Build Completed Successfully"
