name: Multi-Builder (SM8750)

on:
  workflow_dispatch:
    inputs:

      TARGET_WORKFLOW:
        type: choice
        description: "Select Workflow to Trigger"
        required: true
        default: "KSU Meta V2.yml"
        options:
          - KSU Meta V2.yml

      KSU_META:
        type: choice
        description: "KSU Meta"
        required: true
        default: "ReSukiSU"
        options:
          - ReSukiSU
          - SukiSU-Ultra
          - KernelSU-Next
          - WildKSU

      MANAGER_SOURCE:
        type: choice
        description: "KSU Meta Branch (Download Manager Artifact)"
        required: true
        default: "ReSukiSU-Main"
        options:
         - ReSukiSU-Main
         - ReSukiSU-Main-Spoofed
         - SukiSU-Ultra-Main
         - SukiSU-Main-Spoofed
         - KernelSU-Next-Stable
         - KernelSU-Next-Stable-Spoofed
         - KernelSU-Next-Dev
         - KernelSU-Next-Dev-Spoofed
         - WildKSU-Stable
         - WildKSU-Stable-Spoofed
         - WildKSU-Canary
         - WildKSU-Canary-Spoofed

permissions:
  actions: write
  contents: read

jobs:

# =========================
# Generate sm8750 Matrix
# =========================

  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
      - name: Generate sm8750 Device Matrix
        id: set-matrix
        run: |
          FILE_LIST=(
            "oneplus_13_b"
            "oneplus_13s_b"
            "oneplus_13t_b"
            "oneplus_ace5_pro_b"
            "oneplus_ace_6"
            "oneplus_pad_2_pro_b"
            "oneplus_pad_3_b"
          )

          MATRIX_JSON=$(printf '%s\n' "${FILE_LIST[@]}" | jq -R -s -c '
            split("\n")[:-1] |
            map({
              file: .,
              file_short: (sub("_[a-z]$"; "")),
              enable_sched: true
            })
          ')

          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT


# =========================
# Trigger Device Builds
# =========================

  build:
    needs: generate-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}

    steps:

      - name: Trigger Selected Workflow
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: ${{ github.event.inputs.TARGET_WORKFLOW }}
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
          inputs: |
            {
              "FILE": "${{ matrix.file }}",
              "KPM": "KPN",
              "MANAGER_SOURCE": "${{ github.event.inputs.MANAGER_SOURCE }}",
              "SUSFS_META": "",
              "KSU_META": "${{ github.event.inputs.KSU_META }}",
              "ZRAM": "0/1z4kd/8589934592",
              "BUILD_TIME": "",
              "SUFFIX": "8-andreimikhail-4k",
              "LSM": true,
              "NETFILTER": true,
              "BBR_ECN": true,
              "SUSFS_DEV": false,
              "FAST_BUILD": true,
              "SCHED": true,
              "UNICODE_BYPASS": true,
              "XUS_FIX": true
            }

      - name: Wait for Artifact
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FILE="${{ matrix.file_short }}"
          echo "Waiting for artifact: $FILE"

          SECONDS=0
          MAX_TIME=$((35 * 60))
          sleep 600

          while (( SECONDS < MAX_TIME )); do
            ARTIFACTS=$(gh api \
              repos/${{ github.repository }}/actions/artifacts \
              --jq '.artifacts[].name')

            if echo "$ARTIFACTS" | grep -q "$FILE"; then
              echo "Artifact found for $FILE"
              exit 0
            fi

            sleep 300
          done

          echo "Timeout waiting for $FILE"
          exit 1


# =========================
# Collect & Upload ZIPs (No Fusion)
# =========================

  wait-and-package:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Tools
        run: |
          sudo apt update
          sudo apt install -y gh curl jq
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Download Artifacts From Current Run Only
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p final_zips

          RUN_ID="${{ github.run_id }}"
          echo "Fetching artifacts for run ID: $RUN_ID"

          ARTIFACTS=$(gh api \
            repos/${{ github.repository }}/actions/runs/$RUN_ID/artifacts \
            --jq '.artifacts[].name')

          for ART in $ARTIFACTS; do
            echo "Downloading $ART"

            ARTIFACT_ID=$(gh api \
              repos/${{ github.repository }}/actions/runs/$RUN_ID/artifacts \
              --jq ".artifacts[] | select(.name==\"$ART\") | .id")

            curl -L \
              -H "Authorization: token $GH_TOKEN" \
              -o "final_zips/${ART}.zip" \
              "https://api.github.com/repos/${{ github.repository }}/actions/artifacts/${ARTIFACT_ID}/zip"
          done

      - name: Upload Device ZIPs (Separated)
        uses: actions/upload-artifact@v4
        with:
          name: All-AnyKernel3-${{ github.event.inputs.KSU_META }}-sm8750
          path: final_zips/*.zip
