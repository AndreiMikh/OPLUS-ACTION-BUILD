name: Cleanup Workflow Runs

on:
  workflow_dispatch:       # manual trigger
  schedule:
    - cron: '0 3 * * *'   # daily at 3:00 UTC

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Cleanup Workflow Runs
        env:
          GH_PAT: ${{ secrets.GH_PAT }}   # Your PAT with 'workflow' scope
          REPO: ${{ github.repository }}
          KEEP_LAST: 10
        run: |
          # Export token so gh CLI picks it up
          export GH_TOKEN="$GH_PAT"

          echo "Cleaning workflow runs in repository $REPO..."

          # Fetch all workflow IDs
          workflow_ids=$(gh api repos/$REPO/actions/workflows | jq -r '.workflows[].id')

          for wf_id in $workflow_ids; do
            echo "Processing workflow ID: $wf_id"

            # List all runs for this workflow, newest first
            runs=$(gh api repos/$REPO/actions/workflows/$wf_id/runs --paginate | jq -r '.workflow_runs[] | "\(.id) \(.status) \(.conclusion)"')

            count=0
            while read -r run_id status conclusion; do
              # Count only successful completed runs for KEEP_LAST logic
              if [ "$status" = "completed" ] && [ "$conclusion" = "success" ]; then
                count=$((count+1))
              fi

              # Decide whether to delete
              if [ "$status" = "completed" ] && [ "$conclusion" = "success" ] && [ $count -le $KEEP_LAST ]; then
                echo "Keeping successful run $run_id"
              else
                echo "Deleting run $run_id (status=$status, conclusion=$conclusion)..."
                gh api -X DELETE repos/$REPO/actions/runs/$run_id || echo "⚠️ Could not delete run $run_id (skipping)"
              fi
            done <<< "$runs"
          done

          echo "Cleanup complete!"
