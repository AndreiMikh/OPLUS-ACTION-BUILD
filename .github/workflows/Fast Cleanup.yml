name: Cleanup Old Workflow Runs

on:
  workflow_dispatch: # manually triggerable

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Clean Old Workflow Runs
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          KEEP_LAST: 10
        run: |
          echo "Cleaning old workflow runs in repository $REPO..."
          
          # Get all workflow IDs in the repo
          workflow_ids=$(gh api repos/$REPO/actions/workflows | jq -r '.workflows[].id')
          
          for wf_id in $workflow_ids; do
            echo "Processing workflow ID: $wf_id"
            
            # List all runs for this workflow, newest first
            runs=$(gh api repos/$REPO/actions/workflows/$wf_id/runs --paginate | jq -r '.workflow_runs[].id')
            
            # Keep only the last $KEEP_LAST runs
            count=0
            for run_id in $runs; do
              count=$((count+1))
              if [ $count -le $KEEP_LAST ]; then
                echo "Keeping run $run_id"
              else
                echo "Deleting run $run_id"
                gh api -X DELETE repos/$REPO/actions/runs/$run_id
              fi
            done
          done

          echo "Cleanup complete!"
