# ===========================
# OnePlus Kernel Action Build
# ===========================
name: Test-Build
on:
  workflow_dispatch:
    inputs:
      FILE:
        type: choice
        description: "Kernel Manifest Configuration File"
        required: true
        default: oneplus_13_b
        options:
          - oneplus_10_pro_u              # SM8450 - Android/Kernel Version 
          - oneplus_10t_v                 # SM8475 - Android/Kernel Version 
          - oneplus_11r_b                 # SM8475 - Android/Kernel Version 
          - oneplus_ace2_b                # SM8475 - Android/Kernel Version 
          - oneplus_11_b                  # SM8550 - Android/Kernel Version 
          - oneplus_12r_b                 # SM8550 - Android/Kernel Version 
          - oneplus_ace2_pro_b            # SM8550 - Android/Kernel Version 
          - oneplus_ace3_b                # SM8550 - Android/Kernel Version 
          - oneplus_open_b                # SM8550 - Android/Kernel Version 
          - oneplus_nord_ce4_b            # SM7550 - Android/Kernel Version 
          - oneplus_nord_ce4_lite_5g_v    # SM6375 - Android/Kernel Version  
          - oneplus_nord_4_b              # SM7675 - Android/Kernel Version 
          - oneplus_ace_3v_b              # SM7675 - Android/Kernel Version 
          - oneplus_12_b                  # SM8650 - Android/Kernel Version Android16 6.1.118 SUFS OKI (OnePlus Kernel Image) Supported 
          - oneplus_13r_b                 # SM8650 - Android/Kernel Version Android16 6.1.118 SUFS OKI (OnePlus Kernel Image) Supported  
          - oneplus_ace3_pro_b            # SM8650 - Android/Kernel Version Android16 6.1.118 SUFS OKI (OnePlus Kernel Image) Supported 
          - oneplus_ace5_b                # SM8650 - Android/Kernel Version Android16 6.1.118 SUFS OKI (OnePlus Kernel Image) Supported 
          - oneplus_pad_pro_b             # SM8650 - Android/Kernel Version Android16 6.1.118 SUFS OKI (OnePlus Kernel Image) Supported 
          - oneplus_pad2_b                # SM8650 - Android/Kernel Version Android16 6.1.118 SUFS OKI (OnePlus Kernel Image) Supported 
          - oneplus_nord_5_b              # SM8635 - Android/Kernel Version 
          - oneplus_ace5_pro_b            # SM8750 - Android/Kernel Version Android16 6.6.89 SUFS OKI (OnePlus Kernel Image) Supported 
          - oneplus_13_b                  # SM8750 - Android/Kernel Version Android16 6.6.89 SUFS OKI (OnePlus Kernel Image) Supported 
          - oneplus_13t_b                 # SM8750 - Android/Kernel Version Android16 6.6.89 SUFS OKI (OnePlus Kernel Image) Supported 
          - oneplus_13s_b                 # SM8750 - Android/Kernel Version Android16 6.6.89 SUFS OKI (OnePlus Kernel Image) Supported 
          - oneplus_pad_2_pro_b           # SM8750 - Android/Kernel Version Android16 6.6.89 SUFS OKI (OnePlus Kernel Image) Supported 
          - oneplus_pad_3_b               # SM8750 - Android/Kernel Version Android16 6.6.89 SUFS OKI (OnePlus Kernel Image) Supported 
          - oneplus_ace_6                 # SM8750 - Android/Kernel Version Android16 6.6.89 SUFS OKI (OnePlus Kernel Image) Supported 
          - oneplus_ace_6t                # SM8845 - Android/Kernel Version Android16
          - oneplus_15r                   # SM8845 - Android/Kernel Version Android16
          - oneplus_15_custom             # SM8850 - Android/Kernel Version Android16 6.12 SUFS OKI (OnePlus Kernel Image) Supported; Manifest Error
          - oneplus_15_t_aosp             # SM8850 - Android/Kernel Version Android16 6.12 SUFS OKI (OnePlus Kernel Image) Supported 
          - oneplus_15_wild               # SM8850 - Android/Kernel Version Android16 6.12 SUFS OKI (OnePlus Kernel Image) Supported 
          
      KPM:
        type: choice
        description: "Kernel Module Implementation Methods"
        required: true
        default: KPN
        options:
          - KPM
          - KPN
          - None
          
      SUSFS-META:
        type: string
        description: "Rollback SUSFS (Enter Hash or Number or -1 to Turn Off)"
        required: false
        default: ""
        
      DYNAMIC-REPOSITORY:
        type: string
        description: "Dynamic Inventory Warehouse Owner"
        required: true
        default: "AndreiMikh"
        
      BUILDTIME:
        type: string
        description: "Custom Build Time (Input 'F' to Use Current UTC Time)"
        required: false
        default: "Sat Feb 14 07:17:27 UTC 2026"
        
      KSU-META:
        type: choice
        description: "KSU Meta"
        required: true
        default: "ReSukiSU"
        options:
         - ReSukiSU
         - SukiSU-Ultra
         - KernelSU-Next
         - WildKSU
         - KernelSU
       
      KSU-META-SOURCE:
        type: choice
        description: "KSU Meta-Branch (Download Manager Artifact)"
        required: true
        default: ReSukiSU-Main
        options:
         - ReSukiSU-Main
         - ReSukiSU-Main-Spoofed
         - SukiSU-Ultra-Main
         - SukiSU-Main-Spoofed
         - KernelSU-Next-Stable
         - KernelSU-Next-Stable-Spoofed
         - KernelSU-Next-Dev
         - KernelSU-Next-Dev-Spoofed
         - WildKSU-Stable
         - WildKSU-Stable-Spoofed
         - WildKSU-Canary
         - WildKSU-Canary-Spoofed
         - KernelSU-Main
         
      SUSFS-VERSION:
        type: choice
        description: SUSFS for OGKI, Only Available for Version android14-6.1, android15-6.6 & android16-6.12 (susfs4oki)? / SUSFS for GKI (susfs4ksu)?
        required: true
        default: OGKI
        options:
          - OGKI
          - GKI
      
      ZRAM:
        type: string
        description: "ZRAM (0 for Off, 1 for On)/Algorithm Name/Size"
        required: true
        default: "0/lz4kd/8589934592"
        
      SUFFIX:
        type: string
        description: "Custom Kernel Suffix (Use Random String if Not Specified)"
        required: false
        default: "8-andreimikhail-4k"
        
      SUBLEVEL:
        description: "Custom Kernel Level Spoofing (Sublevel)"
        required: false
        default: ""
        
      FASTBUILD:
        type: boolean
        description: "Enable Fast Kernel Build?"
        required: true
        default: true
        
      LSM:
        type: boolean
        description: "Enable Critical Partition Write Protection (BBG)?"
        required: true
        default: true
        
      NETFILTER:
        type: boolean
        description: "Enable Network Feature Extensions (Netfilter)?"
        required: true
        default: true
        
      BBR-ECN:
        type: boolean
        description: "Enable Network Optimization Algorithm (BBR+ECN)?"
        required: true
        default: true
        
      UNICODE-BYPASS:
        type: boolean
        description: "Add Fix for Unicode Invisible Code Point Bypass Read Vulnerability?"
        required: true
        default: true
        
      FENGCHI:
        type: boolean
        description: "Apply HMBIRD? (SM-8750)"
        required: true
        default: false

      ADIOS:
        type: boolean
        description: "Apply ADIOS (Adaptive) I/O Scheduler?"
        required: true
        default: false        
        
      XUS-ERROR-FIX:
        type: boolean
        description: "Prevent Generation of XUS Error Files?"
        required: true
        default: false
        
      SUSFS-DEV-BRANCH:
        type: boolean
        description: "Extract SUSFS-Dev Branch?"
        required: true
        default: false
        
      DISABLE-SPACE-CLEAN:
        type: boolean
        description: "Disable Space Cleaning?"
        required: true
        default: false
        
      DISABLE-COMPILER-CACHE:
        type: boolean
        description: "Disable Compiler Cache Update?"
        required: true
        default: false

jobs:
  build:
    name: >
     ${{
      format(
       '{0}{1}{2}{3}{4}{5}-{6} {7}',
       github.event.inputs.FASTBUILD == 'true' && ' Fast' || '',
       contains(github.event.inputs.FILE, '_aosp') && ' AOSP' || '',
       github.event.inputs.KSU-META == 'SukiSU-Ultra' && ' SukiSU' ||
       github.event.inputs.KSU-META == 'ReSukiSU' && ' ReSukiSU' ||
       github.event.inputs.KSU-META == 'KernelSU-Next' && ' KSUNext' ||
       github.event.inputs.KSU-META == 'WildKSU' && ' WildKSU' || '',
       github.event.inputs.SUSFS-VERSION == 'OGKI' && ' OKI' ||
       github.event.inputs.SUSFS-VERSION == 'GKI' && ' GKI' || '',
       github.event.inputs.KPM == 'KPM' && ' KPM' ||
       github.event.inputs.KPM == 'KPN' && ' KPN' ||
       github.event.inputs.KPM == 'None' && ' None' || '',
       github.event.inputs.LSM == 'true' && ' LSM' || '',
       github.event.inputs.FENGCHI == 'true' && ' Fengchi' || '',
       github.event.inputs.ADIOS == 'true' && ' ADIOS' || '',
       startsWith(github.event.inputs.ZRAM, '1/') && ' ZRAM' || '',
       github.event.inputs.FILE,
       github.event.inputs.SUFFIX
       )
      }}
    runs-on: ubuntu-latest
    env:
      CCACHE_COMPILERCHECK: "%compiler% -dumpmachine; %compiler% -dumpversion"
      CCACHE_NOHASHDIR: "true"
      CCACHE_HARDLINK: "true"
      CCACHE_MAXSIZE: 8G
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Maximize Build Space
        if: ${{ github.event.inputs.DISABLE-SPACE-CLEAN == 'false' }}
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Extract Manifest Information
        id: extract_info
        env:
          FILE: ${{ github.event.inputs.FILE }}
          REPOSITORY-OWNER-INPUT: ${{ github.event.inputs.DYNAMIC-REPOSITORY }}
        run: |
          set -e
          cd "$GITHUB_WORKSPACE"

          echo "Extract Manifest"

          # ==============================
          # Normalize File Name
          # ==============================
          if [[ "$FILE" =~ ^(.+)_([a-zA-Z])$ ]]; then
            FILE_CONF="${BASH_REMATCH[1]}"
          else
            FILE_CONF="$FILE"
          fi
          
          FILE_BASE=$(echo "$FILE_CONF" | sed -E '
            s/_aosp/(AOSP)/g;
            s/_([a-zA-Z0-9])/\U\1/g;
            s/^oneplus/OnePlus/;
            s/^realme/RealME/;
            s/^oppo/OPPO/
          ')

          mkdir -p ".repo/manifests_fallback"
          XML_PATH=".repo/manifests_fallback/${FILE}.xml"
          README_PATH=".repo/manifests_fallback/README.md"

          echo "FILE=$FILE"
          echo "FILE_CONF=$FILE_CONF"
          echo "FILE_BASE=$FILE_BASE"

          {
            echo "FILE_CONF=$FILE_CONF"
            echo "FILE_BASE=$FILE_BASE"
            } >> "$GITHUB_ENV"

            # ==============================
            # Repository Priority:
            # ==============================
            # 1. AndreiMikh/kernel_manifest
            # 2. AndreiMikh/Kernel_Manifest_Appendix
            # 3. User Defined Dynamic Repository
          
            declare -A REPOS
          
            REPOS["AndreiMikh"]="AndreiMikh|kernel_manifest"
            REPOS["Appendix"]="AndreiMikh|Kernel_Manifest_Appendix"

            # ==============================
            # Only Register Dynamic Repository if Input is Not Empty
            # ==============================
            if [[ -n "$REPOSITORY-OWNER-INPUT" ]]; then
             
              # Remove https://github.com/ if User Pasted full URL
              REPOSITORY-OWNER-INPUT="${REPOSITORY-OWNER-INPUT#https://github.com/}"
              REPOSITORY-OWNER-INPUT="${REPOSITORY-OWNER-INPUT%/}"
              
              if [[ "$REPOSITORY-OWNER-INPUT" =~ ^[^/]+/[^/]+$ ]]; then
                echo "Dynamic Repository Detected: $REPOSITORY-OWNER-INPUT"
                REPOS["Dynamic"]="${REPOSITORY-OWNER-INPUT}|kernel_manifest"
              else
                echo "WARNING: Invalid Dynamic Repository Format"
                echo "Expected: OWNER/REPO"
                echo "Provided: $REPOSITORY-OWNER-INPUT"
                echo "Skipping Dynamic Repository Instead of Failing"
              fi
            fi
                        
            FOUND_REPO=""
            FOUND_REPO_NAME=""
            FOUND_BRANCH=""

            check_repo() {
              local ENTRY="$1"
              [[ -z "$ENTRY" ]] && return 1
                     
              local OWNER=${ENTRY%%|*}
              local REPO_NAME=${ENTRY##*|}

              echo ""
              echo ">>> Checking ${OWNER}/${REPO_NAME}"
            
            local API_URL="https://api.github.com/repos/${OWNER}/${REPO_NAME}"

            # ==============================
            # Fetch Branches Safely 
            # ==============================
            local BRANCHES
            BRANCHES=$(curl -fsSL "${API_URL}/branches" \
              | jq -r '.[]?.name' 2>/dev/null || true)

            if [[ -z "$BRANCHES" ]]; then
              echo "Failed to Retrieve Branches for ${OWNER}/${REPO_NAME}"
              return 1
            fi
            
            for BRANCH in $BRANCHES; do
              echo "  → Trying Branch: $BRANCH"
              
              XML_URL="https://raw.githubusercontent.com/${OWNER}/${REPO_NAME}/${BRANCH}/${FILE}.xml"
              README_URL="https://raw.githubusercontent.com/${OWNER}/${REPO_NAME}/${BRANCH}/README.md"

              if curl -sf --head "$XML_URL" >/dev/null; then
                echo "Found ${FILE}.xml in ${OWNER}/${REPO_NAME} (Branch: $BRANCH)"

                # Download XML & README using GitHub Token
                curl -fsSL -o "$XML_PATH" "$XML_URL"
                curl -fsSL -o "$README_PATH" "$README_URL" || true

                FOUND_REPO="$OWNER"
                FOUND_REPO_NAME="$REPO_NAME"
                FOUND_BRANCH="$BRANCH"

                return 0
              fi
            done

            echo "Not Found in ${OWNER}/${REPO_NAME}"
            return 1
          }

          # ==============================
          # Ordered Search
          # ==============================
          for key in AndreiMikh Appendix Dynamic; do
            if [[ -n "${REPOS[$key]}" ]]; then
              if check_repo "${REPOS[$key]}"; then
                break
              fi
            fi
          done

          # ==============================
          # Final Validation
          # ==============================
          if [[ -z "$FOUND_REPO" || ! -s "$XML_PATH" ]]; then
            echo ""
            echo "Error: ${FILE}.xml Not Found in any Configured Repository"
            exit 9
          fi

          echo ""
          echo "============= Manifest Located ============="
          echo "Repository : ${FOUND_REPO}/${FOUND_REPO_NAME}"
          echo "Branch     : ${FOUND_BRANCH}"
          echo "============================================"

          {
            echo "MANIFEST_REPO=$FOUND_REPO"
            echo "MANIFEST_REPO_NAME=$FOUND_REPO_NAME"
            echo "MANIFEST_BRANCH=$FOUND_BRANCH"
          } >> "$GITHUB_ENV"

          # ==============================
          # Parse Revision String
          # ==============================
          echo "Parsing Manifest"

          REVISION=$(grep -oP '<project[^>]+revision="\K[^"]+' "$XML_PATH" | head -n1 || true)

          if [[ -z "${REVISION:-}" ]]; then
            echo "ERROR: No Revision String Found in XML"
            exit 1
          fi

          echo "REVISION=$REVISION"
          echo "Parsing CPU & Android Version..."
  
          # ==============================
          # Extract CPU
          # ==============================        
          CPU=$(echo "$REVISION" | sed -E 's#^(oneplus|realme|oppo)/([^_]+).*#\2#')

          # ==============================
          # Extract Android Version (e.g. 13.0 or 14.0.1)
          # ==============================
          ANDROID_VERSION=$(echo "$REVISION" | grep -oE '[0-9]{1,2}\.[0-9]{1,2}(\.[0-9]{1,2})?' | head -n1 || true)

          if [[ -z "$CPU" || -z "$ANDROID_VERSION" ]]; then
            echo "ERROR: Failed to extract CPU or Android Version"
            exit 1
          fi

          ANDROID_SHORT_VERSION="${ANDROID_VERSION%%.*}"

          echo "CPU=$CPU"
          echo "ANDROID_VERSION=$ANDROID_VERSION"
          echo "ANDROID_SHORT_VERSION=$ANDROID_SHORT_VERSION"

          {
            echo "CPU=$CPU"
            echo "ANDROID_VERSION=$ANDROID_VERSION"
            echo "ANDROID_SHORT_VERSION=$ANDROID_SHORT_VERSION"
          } >> "$GITHUB_ENV"

          # ==============================
          # Parse README to Obtain CPUD & Build Method
          # ==============================
          echo "Parsing README"

          if [[ -s "$README_PATH" ]]; then
            BUILD_LINE=$(grep -m1 'oplus_build_kernel.sh' "$README_PATH" || true)

            if [[ -n "$BUILD_LINE" ]]; then
              # More Reliable Extraction: Pull Last Two Arguments
              CPUD=$(awk '{print $(NF-1)}' <<< "$BUILD_LINE")
              BUILD_METHOD=$(awk '{print $NF}' <<< "$BUILD_LINE")

              echo "CPUD=$CPUD"
              echo "BUILD_METHOD=$BUILD_METHOD"

              {
                echo "CPUD=$CPUD"
                echo "BUILD_METHOD=$BUILD_METHOD"
              } >> "$GITHUB_ENV"
            else
              echo "WARNING: Build Command Not Found in README.md"
            fi
          else
            echo "WARNING: README Missing or Empty"
          fi

          # Export Combined Output Value
          echo "value=${FILE_BASE}_Android${ANDROID_VERSION}" >> "$GITHUB_OUTPUT"

          echo "Manifest Parsing Complete"    
          
      - name: Debug – Show Selected Inputs
        shell: bash
        run: |
          set -euo pipefail

          echo "--- DEBUG INPUTS ---"

           # Helper: Print Unicode Codepoints
           print_unicode() {
             local LABEL="$1"
             local VALUE="$2"

             echo -n "$LABEL Unicode: "

             python3 <<EOF
          import unicodedata
          value = """$VALUE"""
          output = []
          for c in value:
              code = f"U+{ord(c):04X}"
              if c.isspace() or unicodedata.category(c) == "Cf":
                  output.append(f"\033[31m{code}\033[0m")
              else:
                  output.append(code)
          print(" ".join(output))
          EOF
                echo
              }

              # ENV Variables (Parsed from Manifest) 
              echo "--- Manifest Parsed Values ---"
              echo "CPU               : ${CPU:-<empty>}"
              echo "CPUD              : ${CPUD:-<empty>}"
              echo "ANDROID_VERSION   : ${ANDROID_VERSION:-<empty>}"
              echo "BUILD_METHOD      : ${BUILD_METHOD:-<empty>}"

              # GitHub Action Inputs
              echo "--- GitHub Inputs ---"
              echo "FILE              : ${{ github.event.inputs.FILE }}"
              echo "KPM               : ${{ github.event.inputs.KPM }}"
              echo "KSU-META-SOURCE   : ${{ github.event.inputs.KSU-META-SOURCE }}"
              echo "SUSFS-META        : ${{ github.event.inputs.SUSFS-META }}"
              echo "KSU-META          : ${{ github.event.inputs.KSU-META }}"
              echo "ZRAM              : ${{ github.event.inputs.ZRAM }}"
              echo "BUILDTIME         : ${{ github.event.inputs.BUILDTIME }}"
              echo "SUFFIX            : ${{ github.event.inputs.SUFFIX }}"
              echo "LSM               : ${{ github.event.inputs.LSM }}"
              echo "NETFILTER         : ${{ github.event.inputs.NETFILTER }}"
              echo "BBR-ECN           : ${{ github.event.inputs.BBR-ECN }}"
              echo "SUSFS-VERSION     : ${{ github.event.inputs.SUSFS-VERSION }}"
              echo "SUSFS-DEV-BRANCH  : ${{ github.event.inputs.SUSFS-DEV-BRANCH }}"
              echo "FASTBUILD         : ${{ github.event.inputs.FASTBUILD }}"
              echo "FENGCHI           : ${{ github.event.inputs.FENGCHI }}"
              echo "ADIOS             : ${{ github.event.inputs.ADIOS }}"
              echo "UNICODE-BYPASS    : ${{ github.event.inputs.UNICODE-BYPASS }}"
              echo "XUS-ERROR-FIX     : ${{ github.event.inputs.XUS-ERROR-FIX }}"
              
              # Unicode Inspection (Whitespace / Hidden Character Detection)
              print_unicode "BUILDTIME" "${{ github.event.inputs.BUILDTIME }}"
              print_unicode "SUFFIX" "${{ github.event.inputs.SUFFIX }}"

      - name: Check Disk Space
        run: df -h

      - name: Create & Enable 3G Swap
        run: |
          sudo swapoff -a
          sudo fallocate -l 3G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          free -h

      - name: Set Cache Environment
        if: ${{ github.event.inputs.DISABLE-COMPILER-CACHE == 'false' }}
        run: |
          echo "CCACHE_DIR=$HOME/.ccache_${{ github.event.inputs.FILE }}" >> $GITHUB_ENV
          mkdir -p "$HOME/.ccache_${{ github.event.inputs.FILE }}"
          echo "set: $HOME/.ccache_${{ github.event.inputs.FILE }}"

      - name: Set GIT User
        run: |
          git config --global user.name "AndreiMikh"
          git config --global user.email "andreimikhail0088@gmail.com"
          
      - name: Setup Required Packages
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: |
            python3
            git
            curl
            ccache
            libelf-dev
            build-essential
            flex
            bison
            libssl-dev
            libncurses-dev
            liblz4-tool
            zlib1g-dev
            libxml2-utils
            rsync
            unzip
            gawk
            dos2unix
            kmod
            libdw-dev
            elfutils
          execute_install_scripts: true

      - name: Load Ccache
        if: ${{ github.event.inputs.DISABLE-COMPILER-CACHE == 'false' }}
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: >
            ccache-${{ runner.os }}-${{ github.ref_name }}-
            ${{ github.event.inputs.FILE }}-${{ env.BUILD_METHOD }}-
            ${{ github.event.inputs.FASTBUILD == 'true' && 'alpha' || 'beta' }}-16.2

      - name: Setup Compiler Cache
        if: ${{ github.event.inputs.DISABLE-COMPILER-CACHE == 'false' }}
        run: |
          INIT_FLAG="${{ env.CCACHE_DIR }}/.ccache_initialized"

          if command -v ccache >/dev/null 2>&1; then
            if [ ! -f "$INIT_FLAG" ]; then
              echo "Setting up Compiler Cache at ${{ env.CCACHE_DIR }}..."
              mkdir -p "${{ env.CCACHE_DIR }}"
              ccache -M ${{ env.CCACHE_MAXSIZE }}
              touch "$INIT_FLAG"
              echo "Compiler Cache Setup Complete"
            else
              echo "Compiler Cache Already Initialized, Skipping"
            fi
          else
            echo "Ccache Not Installed, Skipping Compiler Cache Setup"
          fi

          # ==============================
          # Display Current Compiler Cache Statistics
          # ==============================
          ccache -s

      - name: Setup Google Repository Tool
        run: |
          echo "Downloading Google Repository Tool..."
          curl -sSL https://storage.googleapis.com/git-repo-downloads/repo -o ~/repo
          chmod +x ~/repo
          sudo mv ~/repo /usr/local/bin/repo
          echo "Google Repository Tool Installed Successfully"

      - name: Initialize & Sync Repository
        env:
          FILE: ${{ github.event.inputs.FILE }}
        run: |
          echo "Creating Kernel Workspace..."
          mkdir -p kernel_workspace && cd kernel_workspace

          echo "Setting up Manifest Directory..."
          mkdir -p .repo/manifests
          cp "$GITHUB_WORKSPACE/.repo/manifests_fallback/${FILE}.xml" ".repo/manifests/${FILE}.xml"

          BASE_URL="https://github.com/${MANIFEST_REPO}/${MANIFEST_REPO_NAME}.git"
          echo "Initializing repository using $MANIFEST_REPO/$MANIFEST_REPO_NAME ($MANIFEST_BRANCH)..."
          repo init -u "$BASE_URL" -b "$MANIFEST_BRANCH" -m "${FILE}.xml" --depth=1 --no-clone-bundle --no-tags

          echo "Syncing Repository..."
          repo sync -c -j$(nproc) --no-clone-bundle --no-tags --force-sync

          echo "Auto Detecting Kernel Repository..."

          KERNEL_REPOS=""

          KERNEL_REPOS_PATH=$(find . -type f -name "build.config*" | grep -v "abi" | head -n 1)

          if [[ -n "$KERNEL_REPOS_PATH" ]]; then
            echo "Found build config at: $KERNEL_REPOS_PATH"

            # ==============================
            # Extract Top-Level Kernel Folder
            # ==============================
            KERNEL_REPOS=$(echo "${KERNEL_REPOS_PATH#./}" | cut -d/ -f1)

            echo "Detected Kernel Repository: $KERNEL_REPOS"
            echo "KERNEL_REPOS=$KERNEL_REPOS" >> "$GITHUB_ENV"
          else
            echo "ERROR: No build.config file found after repo sync!"
            find . -name "build.config*" || true
            exit 1
          fi          

          echo "Cleaning up Build Bazel Files & Protected Exports..."
          for dir in kernel_platform/common kernel_platform/msm-kernel; do
            if [ -e "$dir/BUILD.bazel" ]; then
              sed -i '/^[[:space:]]*"protected_exports_list"[[:space:]]*:[[:space:]]*"android\/abi_gki_protected_exports_aarch64",$/d' "$dir/BUILD.bazel"
            fi
            rm -f "$dir/android/abi_gki_protected_exports_"* 2>/dev/null || echo "No protected exports in $dir"
          done

          echo "Repository Initialization & Sync Complete"

      - name: Kernel Version Setup
        run: |
          cd kernel_workspace/kernel_platform

          echo "Determining Android and Kernel Branch Versions..."
          BRANCH=""
          for f in ./common/build.config.constants ./common/build.config.common; do
            [ -f "$f" ] && BRANCH=$(grep -m1 '^BRANCH=' "$f" | cut -d= -f2) && [ -n "$BRANCH" ] && break
          done

          if [[ -z "$BRANCH" && -n "$KERNEL_REPOS" ]]; then
            BRANCH=$(sed -n '2p' "./$KERNEL_REPOS/android/ACK_SHA" | awk -F'-' '{print $1"-"$2}')
          fi

          if [ -n "$BRANCH" ]; then
            echo "ANDROID-VERSION=${BRANCH%-*}" >> $GITHUB_ENV
            echo "KERNEL_VERSION=${BRANCH#*-}" >> $GITHUB_ENV
            echo "Branch found: $BRANCH"
          else
            echo "No Branch Found in Build Config or ACK_SHA."
          fi

          echo "Reading Original Kernel Version..."
          ORIG_VERSION=$(awk '/^VERSION =/ {v=$3} /^PATCHLEVEL =/ {p=$3} /^SUBLEVEL =/ {s=$3} END {print v"."p"."s}' ./common/Makefile)

          SUBLEVEL_INPUT="${{ github.event.inputs.SUBLEVEL }}"
          if [ -n "$SUBLEVEL_INPUT" ]; then
            echo "Updating Sublevel to: $SUBLEVEL_INPUT"
            sed -i "s/^\(SUBLEVEL[[:space:]]*=[[:space:]]*\).*/\1$SUBLEVEL_INPUT/" ./common/Makefile
          else
            echo "No Sublevel Input Provided; Keeping Default"
          fi

          NEW_VERSION=$(awk '/^VERSION =/ {v=$3} /^PATCHLEVEL =/ {p=$3} /^SUBLEVEL =/ {s=$3} END {print v"."p"."s}' ./common/Makefile)

          if [ "$ORIG_VERSION" != "$NEW_VERSION" ]; then
            echo "Kernel Version Changed: $ORIG_VERSION -> $NEW_VERSION"
            echo "TKERNEL_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          else
            echo "Kernel Version Unchanged: $ORIG_VERSION"
            echo "TKERNEL_VERSION=$ORIG_VERSION" >> $GITHUB_ENV
          fi

          KV_TMP="${BRANCH#*-}"
          echo "KV1=$(echo "$KV_TMP" | cut -d. -f1)" >> $GITHUB_ENV
          echo "KV2=$(echo "$KV_TMP" | tr -d '.')" >> $GITHUB_ENV
          echo "KV3=$(echo "$NEW_VERSION" | tr -d '.')" >> $GITHUB_ENV

      - name: Rust Compiler Setup
        run: |
          cd kernel_workspace/kernel_platform

          echo "Checking Rust Compiler Version..."
          RUSTC_VERSION=""
          if [[ -f ./common/build.config.constants ]]; then
            RUSTC_VERSION=$(grep '^RUSTC_VERSION=' ./common/build.config.constants | cut -d'=' -f2 || true)
          fi

          if [[ -n "$RUSTC_VERSION" ]]; then
            echo "Found Rustc Version: $RUSTC_VERSION"
            echo "RUSTC_VERSION=$RUSTC_VERSION" >> $GITHUB_ENV
            echo "ENABLE_RUST=true" >> $GITHUB_ENV
          else
            echo "Rustc Version Not Found; Rust Compilation Disabled"
            echo "ENABLE_RUST=false" >> $GITHUB_ENV
          fi

      - name: Inject Custom Kernel Version Suffix
        if: ${{ github.event.inputs.SUFFIX != '' }}
        run: |
          cd kernel_workspace

          SUFFIX="${{ github.event.inputs.SUFFIX }}"
          ANDROID-VERSION="${{ env.ANDROID-VERSION }}"
          FASTBUILD="${{ github.event.inputs.FASTBUILD }}"

          echo "Injecting Custom Kernel Suffix: $SUFFIX"

          for path in \
            kernel_platform/common/scripts/setlocalversion \
            kernel_platform/msm-kernel/scripts/setlocalversion \
            kernel_platform/external/dtc/scripts/setlocalversion; do

            [ -f "$path" ] || continue
            echo "Processing: $path"

            # ==============================
            # Remove -dirty Tags
            # ==============================
            sed -i 's/ -dirty//g' "$path"
            sed -i '$i res=$(echo "$res" | sed '\''s/-dirty//g'\'')' "$path"

            if grep -q 'KERNELVERSION.*scm_version' "$path"; then
              echo "New SetLocalVersion Format Detected"
              sed -i "s|echo \"\${KERNELVERSION}.*scm_version}\"|echo \"\${KERNELVERSION}-${ANDROID-VERSION}-${SUFFIX}\"|" "$path"

            elif grep -q 'echo "\$res"' "$path"; then
              echo "Old SetLocalVersion Format Detected"

              if [ "$FASTBUILD" = "true" ]; then
                echo "Fast Build Enabled: Setting Static Res Value"
                sed -i "s/^res=.*/res=\"-${ANDROID-VERSION}-${SUFFIX}\"/" "$path"
              else
                echo "Standard Build: Dynamically Injecting Suffix"
                if [[ -f ./kernel_platform/build_with_bazel.py ]]; then
                  echo "Note: Using Bazel may Limit Special Characters, Adjust Script if Compilation Fails"
                fi
                tac "$path" | sed "0,/echo \"\\\$res\"/s//res=\\\$(echo \\\$res | cut -d- -f1-2)-${SUFFIX}; echo \"\\\$res\";/" | tac > "$path.tmp"
                mv "$path.tmp" "$path"
              fi

            else
              echo "Unknown Format: Appending Suffix Manually"
              echo "echo \"\$res-${SUFFIX}\"" >> "$path"
            fi

            chmod +x "$path"
          done

          echo "Committing Suffix Modifications..."
          git add -A
          git commit -m "Inject Custom Kernel Suffix & Remove -dirty Tags"

      - name: Apply Auto-Generated Kernel Suffix
        if: ${{ github.event.inputs.SUFFIX == '' }}
        run: |
          cd kernel_workspace

          ANDROID-VERSION="${{ env.ANDROID-VERSION }}"
          FASTBUILD="${{ github.event.inputs.FASTBUILD }}"

          echo "Generating Random Kernel Suffix..."
          RANDOM_DIGIT=$(od -An -N1 -tu1 < /dev/urandom | tr -d '[:space:]' | awk '{print $1 % 11}')
          RANDOM_HASH=$(od -An -N7 -tx1 /dev/urandom | tr -d ' \n')
          AUTO_SUFFIX="${RANDOM_DIGIT}-o-g${RANDOM_HASH}"

          echo "Random Suffix Generated: $AUTO_SUFFIX"

          for path in \
            kernel_platform/common/scripts/setlocalversion \
            kernel_platform/msm-kernel/scripts/setlocalversion \
            kernel_platform/external/dtc/scripts/setlocalversion; do

            [ -f "$path" ] || continue
            echo "Processing: $path"

            # ==============================
            # Remove -dirty Markers
            # ==============================
            sed -i 's/ -dirty//g' "$path"
            sed -i '$i res=$(echo "$res" | sed '\''s/-dirty//g'\'')' "$path"

            if grep -q 'KERNELVERSION.*scm_version' "$path"; then
              echo "New SetLocalVersion Format Detected"
              sed -i "s|echo \"\${KERNELVERSION}.*scm_version}\"|echo \"\${KERNELVERSION}-${ANDROID-VERSION}-${AUTO_SUFFIX}\"|" "$path"

            elif grep -q 'echo "\$res"' "$path"; then
              echo "Old SetLocalVersion Format Detected"

              if [ "$FASTBUILD" = "true" ]; then
                echo "Fast Build: Using Static Res with Random Suffix"
                sed -i "s/^res=.*/res=\"-${ANDROID-VERSION}-${AUTO_SUFFIX}\"/" "$path"
              else
                echo "Standard Build: Injecting Random Suffix Dynamically"
                tac "$path" | sed "0,/echo \"\\\$res\"/s//res=\\\$(echo \\\$res | cut -d- -f1-2)-${AUTO_SUFFIX}; echo \"\\\$res\";/" | tac > "$path.tmp"
                mv "$path.tmp" "$path"
              fi

            else
              echo "Unknown Format: Appending Random Suffix Manually"
              echo "echo \"\$res-${AUTO_SUFFIX}\"" >> "$path"
            fi

            chmod +x "$path"
          done

          echo "Committing Changes with Auto-Generated Kernel Suffix..."
          git add -A
          git commit -m "Apply auto-generated kernel suffix & remove -dirty markers"

      - name: Re-Solve KSU Meta Source
        id: manager
        run: |
          KSU-META-SOURCE="${{ github.event.inputs.KSU-META-SOURCE }}"
          KSU-META="${{ github.event.inputs.KSU-META }}"

          # ==============================
          # Re-Solve KSU Meta Downloader Branch + Artifact
          # ==============================
          case "$KSU-META-SOURCE" in
            SukiSU-Ultra-Main)
              BRANCH="main"
              ARTIFACT="Manager"
              ;;
            SukiSU-Ultra-Main-Spoofed)
              BRANCH="main"
              ARTIFACT="Spoofed-Manager"
              ;;
            KernelSU-Next-Stable)
              BRANCH="stable"
              ARTIFACT="manager"
              ;;
            KernelSU-Next-Stable-Spoofed)
              BRANCH="stable"
              ARTIFACT="manager-spoofed"
              ;;
            KernelSU-Next-Dev)
              BRANCH="dev"
              ARTIFACT="manager"
              ;;
            KernelSU-Next-Dev-Spoofed)
              BRANCH="dev"
              ARTIFACT="manager-spoofed"
              ;;
            WildKSU-Stable)
              BRANCH="stable"
              ARTIFACT="manager"
              ;;
            WildKSU-Stable-Spoofed)
              BRANCH="stable"
              ARTIFACT="manager-spoofed"
              ;;
            WildKSU-Canary)
              BRANCH="canary"
              ARTIFACT="manager"
              ;;
            WildKSU-Canary-Spoofed)
              BRANCH="stable"
              ARTIFACT="manager-spoofed"
              ;;
            KernelSU-Main)
              BRANCH="main"
              ARTIFACT="manager"
              ;;
            ReSukiSU-Main)
              BRANCH="main"
              ARTIFACT="Manager-release"
              ;;
            ReSukiSU-Main-Spoofed|*)
              BRANCH="stable"
              ARTIFACT="Spoofed-Manager-release"
              ;;
          esac

          # ==============================
          # Re-Solve Actual Repository (Critical Fix)
          # ==============================
          case "$KSU-META" in
            SukiSU-Ultra)
              REPO="SukiSU-Ultra/SukiSU-Ultra"
              ;;
            KernelSU-Next)
              REPO="KernelSU-Next/KernelSU-Next"
              ;;
            WildKSU)
              REPO="WildKernels/Wild_KSU"
              ;;
            ReSukiSU)
              REPO="ReSukiSU/ReSukiSU"
              ;;
            KernelSU)
              REPO="tiann/KernelSU"
              ;;
              
            *)
              echo "Unsupported KSU Meta: $KSU-META"
              exit 1
              ;;
          esac

          echo "MANAGER_BRANCH=$BRANCH" >> "$GITHUB_OUTPUT"
          echo "MANAGER_ARTIFACT=$ARTIFACT" >> "$GITHUB_OUTPUT"
          echo "KSU_REPO=$REPO" >> "$GITHUB_OUTPUT"

          echo "Resolved:"
          echo "  Repo: $REPO"
          echo "  Branch: $BRANCH"
          echo "  Artifact: $ARTIFACT"
           
      - name: Add Selected KSU Meta
        run: |
          set -e

          cd kernel_workspace/kernel_platform || exit 1

          MANAGER_BRANCH="${{ steps.manager.outputs.MANAGER_BRANCH }}"
          KSU-META="${{ github.event.inputs.KSU-META }}"

          get_commit_count_version() {
            local repo="$1"
            local branch="$2"
            local offset="$3"

            LAST_PAGE=$(curl -sI \
              "https://api.github.com/repos/${repo}/commits?sha=${branch}&per_page=1" \
              | sed -n 's/.*page=\([0-9]*\)>; rel="last".*/\1/p')

            echo $((LAST_PAGE + offset))
          }

          get_latest_tag() {
            local repo="$1"
            curl -sL "https://api.github.com/repos/${repo}/tags" \
              | grep -o '"name": *"[^"]*"' \
              | head -n1 \
              | cut -d'"' -f4
          }

          if [[ "$KSU-META" == "SukiSU-Ultra" ]]; then
            echo "Configuring SukiSU-Ultra..."

            REPO="ShirkNeko/SukiSU-Ultra"

            curl -fsSL \
              "https://raw.githubusercontent.com/${REPO}/${MANAGER_BRANCH}/kernel/setup.sh" \
              | bash -s builtin

            cd ./KernelSU || exit 1

            GIT_COMMIT_HASH=$(git rev-parse --short=8 HEAD)
            echo "Current Commit Hash: $GIT_COMMIT_HASH"

            # ==============================
            # Get API Version (Retry 3 Times)
            # ==============================
            for i in {1..3}; do
              KSU_API_VERSION=$(curl -s \
                "https://raw.githubusercontent.com/${REPO}/builtin/kernel/Kbuild" \
                | grep -m1 "KSU_VERSION_API :=" \
                | awk -F'= ' '{print $2}' \
                | tr -d '[:space:]')
              [ -n "$KSU_API_VERSION" ] && break || sleep 1
            done

            [ -z "$KSU_API_VERSION" ] && KSU_API_VERSION="3.1.7"

            echo "KSU_API_VERSION=$KSU_API_VERSION" >> "$GITHUB_ENV"

            # ==============================
            # Generate Commit-Based Version
            # ==============================
            KSU-META-VERSION=$(( $(git rev-list --count main 2>/dev/null || echo 114514) + 37185 ))
            echo "KSU-META-VER=$KSU-META-VERSION" >> "$GITHUB_ENV"

            echo "SukiSU-Ultra Version: v${KSU_API_VERSION}-${GIT_COMMIT_HASH}"

          elif [[ "$KSU-META" == "ReSukiSU" ]]; then
            echo "Configuring ReSukiSU..."

            REPO="ReSukiSU/ReSukiSU"

            curl -fsSL \
              "https://raw.githubusercontent.com/${REPO}/${MANAGER_BRANCH}/kernel/setup.sh" \
              | bash -s "$MANAGER_BRANCH"

            echo 'CONFIG_KSU_FULL_NAME_FORMAT="%TAG_NAME%"' >> ./common/arch/arm64/configs/gki_defconfig

            cd ./KernelSU || exit 1

            KSU-META-VERSION=$(( $(git rev-list --count main 2>/dev/null || echo 114514) + 30700 ))
            echo "KSU-META-VER=$KSU-META-VERSION" >> "$GITHUB_ENV"

            # ==============================
            # Detect DefConfig Path
            # ==============================
            if [[ -f ../common/arch/arm64/configs/gki_defconfig ]]; then
              DEFCONFIG="../common/arch/arm64/configs/gki_defconfig"
            elif [[ -f ../arch/arm64/configs/gki_defconfig ]]; then
              DEFCONFIG="../arch/arm64/configs/gki_defconfig"
            else
              echo "GKI DefConfig Not Found!"
              exit 1
            fi

            # ==============================
            # Remove Old Entry to Prevent Duplication
            # ==============================
            sed -i '/CONFIG_KSU_FULL_NAME_FORMAT/d' "$DEFCONFIG"

            # ==============================
            # Add Formatted Name
            # ==============================
            printf 'CONFIG_KSU_FULL_NAME_FORMAT="ReSukiSU-%%TAG_NAME%%[%s]"\n' "$KSU-META-VERSION" >> "$DEFCONFIG"
            
          elif [[ "$KSU-META" == "KernelSU-Next" ]]; then
            echo "Configuring KernelSU-Next..."

            REPO="KernelSU-Next/KernelSU-Next"

            curl -fsSL \
              "https://raw.githubusercontent.com/${REPO}/${MANAGER_BRANCH}/kernel/setup.sh" \
              | bash -s "$MANAGER_BRANCH"

            cd ./KernelSU-Next || exit 1

            KSU-META-VERSION=$(get_commit_count_version "$REPO" "$MANAGER_BRANCH" 30000)
            echo "KSU-META-VER=$KSU-META-VERSION" >> "$GITHUB_ENV"

            sed -i \
              "s/KSU_VERSION_FALLBACK := 1/KSU_VERSION_FALLBACK := $KSU-META-VERSION/" \
              kernel/Kbuild

            KSU_GIT_TAG=$(get_latest_tag "$REPO")

            sed -i \
              "s/KSU_VERSION_TAG_FALLBACK := v0.0.1/KSU_VERSION_TAG_FALLBACK := $KSU_GIT_TAG/" \
              kernel/Kbuild

            # ==============================
            # Apply Multi-Manager Patch
            # ==============================
            cd ../KernelSU-Next || exit 1

            PATCH_BASE="https://github.com/AndreiMikh/AndreiMikh-Kernel-Lab/raw/refs/heads/LiquidAndrei/patches"

            PATCH_LIST=(
              multi_manager.patch
              overwrite_hook_mode.patch
            )

            for p in "${PATCH_LIST[@]}"; do
              echo "Downloading $p..."
              curl -fsSL "$PATCH_BASE/$p" -o "$p"
            
              echo "Applying $p..."

              if patch -p1 --forward < "$p"; then
                echo "$p Applied Successfully"
              else
                echo "$p Already Applied or Failed, Skipping..."
              fi
            done

            echo "All KernelSU-Next Patches Processed"

          elif [[ "$KSU-META" == "WildKSU" ]]; then
            echo "Configuring WildKSU..."

            REPO="WildKernels/Wild_KSU"

            curl -fsSL \
              "https://raw.githubusercontent.com/${REPO}/${MANAGER_BRANCH}/kernel/setup.sh" \
              | bash -s "$MANAGER_BRANCH"

            cd ./Wild_KSU || exit 1

            KSU-META-VERSION=$(get_commit_count_version "$REPO" "$MANAGER_BRANCH" 30000)
            echo "KSU-META-VER=$KSU-META-VERSION" >> "$GITHUB_ENV"

            sed -i \
              "s/KSU_VERSION_FALLBACK := 1/KSU_VERSION_FALLBACK := $KSU-META-VERSION/" \
              kernel/Kbuild

            KSU_GIT_TAG=$(get_latest_tag "$REPO")

            sed -i \
              "s/KSU_VERSION_TAG_FALLBACK := v0.0.1/KSU_VERSION_TAG_FALLBACK := $KSU_GIT_TAG/" \
              kernel/Kbuild

          elif [[ "$KSU-META" == "KernelSU" ]]; then
            echo "Configuring KernelSU..."

            REPO="tiann/KernelSU"

            curl -fsSL \
              "https://raw.githubusercontent.com/${REPO}/${MANAGER_BRANCH}/kernel/setup.sh" \
              | bash -s "$MANAGER_BRANCH"

            cd ./KernelSU || exit 1

            KSU-META-VERSION=$(get_commit_count_version "$REPO" "$MANAGER_BRANCH" 30000)
            echo "KSU-META-VER=$KSU-META-VERSION" >> "$GITHUB_ENV"

            sed -i \
              "s/KSU_VERSION_FALLBACK := 1/KSU_VERSION_FALLBACK := $KSU-META-VERSION/" \
              kernel/Kbuild

            KSU_GIT_TAG=$(get_latest_tag "$REPO")

            sed -i "s/^DKSU_VERSION=16$/DKSU_VERSION=${KSU-META-VERSION}/" kernel/Kbuild

          else
            echo "No built-in KSU Meta Selected, Skipping..."
          fi

      - name: Apply SUSFS Patches (Auto Official / Fallback) & Other Patches
        if: ${{ github.event.inputs.SUSFS-META != '-1' }}
        run: |
          set -e

          cd kernel_workspace

          echo "====== Clone Patch ======"
          git clone --depth=1 https://github.com/ShirkNeko/SukiSU_patch.git
          git clone --depth=1 https://github.com/AndreiMikh/AndreiMikh-Kernel-Lab.git
          echo "Patch Cloned"
          echo "=========================="

          echo "====== Adding SUSFS ======"
          echo "Android: ${{ env.ANDROID-VERSION }}"
          echo "Kernel:  ${{ env.KERNEL_VERSION }}"
          echo "=========================="

          # ==============================
          # Detect Kernel Base
          # ==============================
          GKI-OKI-VERSION="${{ env.ANDROID-VERSION }}-${{ env.KERNEL_VERSION }}"
          echo "Detected GKI Version: $GKI-OKI-VERSION"

          # ==============================
          # Detect Correct Kernel Common Directory
          # ==============================
          if [ -d "./kernel_platform/common" ]; then
            KDIR="./kernel_platform/common"
          elif [ -d "./common" ]; then
            KDIR="./common"
          else
            echo "ERROR: Cannot Find Kernel Common Directory!"
            exit 1
          fi

          echo "Using Kernel Directory: $KDIR"
          
          # ==============================
          # Clone Correct SUSFS Repository (Select Between SUSFS OGKI / GKI)
          # ==============================
          if [[ ("$GKI-OKI-VERSION" == "android14-6.1" || "$GKI-OKI-VERSION" == "android15-6.6" || "$GKI-OKI-VERSION" == "android16-6.12") && "${{ github.event.inputs.SUSFS-VERSION }}" == "OGKI" ]]; then
              echo "If Both Conditions are Met, Executing Specific Logic of SUSFS OGKI Repository"

              # Check for SUSFS OGKI Development Branch if Selected
              if [[ "${{ github.event.inputs.SUSFS-DEV-BRANCH }}" == "true" ]]; then
                  echo "Cloning SUSFS OGKI Development Branch"
                  git clone --depth=1 \
                     https://github.com/cctv18/susfs4oki.git susfs4ksu \
                     -b "oki-${{ env.ANDROID-VERSION }}-${{ env.KERNEL_VERSION }}-dev"
              else
                  echo "Cloning SUSFS OGKI Main Branch"
                  git clone --depth=1 \
                     https://github.com/cctv18/susfs4oki.git susfs4ksu \
                     -b oki-${{ env.ANDROID-VERSION }}-${{ env.KERNEL_VERSION }}
              fi
          
          elif [[ "${{ github.event.inputs.SUSFS-VERSION }}" == "GKI" ]]; then
              echo "Using SUSFS GKI Repository"

              # Check for GKI Development Branch if Selected
              if [[ "${{ github.event.inputs.SUSFS-DEV-BRANCH }}" == "true" ]]; then
                  echo "Cloning SUSFS GKI Development Branch"
                  git clone --depth=1 \
                     https://gitlab.com/simonpunk/susfs4ksu.git susfs4ksu \
                     -b "gki-${{ env.ANDROID-VERSION }}-${{ env.KERNEL_VERSION }}-dev"
              else
                  echo "Cloning SUSFS GKI Main Branch"
                  git clone --depth=1 \
                     https://gitlab.com/simonpunk/susfs4ksu.git susfs4ksu \
                     -b gki-${{ env.ANDROID-VERSION }}-${{ env.KERNEL_VERSION }}
              fi
          else
              echo "ERROR: Invalid SUSFS Version Selected!"
              exit 1
          fi

          # ==============================
          # Validate Repository Structure
          # ==============================
          if [ ! -d "susfs4ksu" ]; then
            echo "ERROR: SUSFS Repository Failed to Clone!"
            exit 1
          fi

          # ==============================
          # Optional SUSFS Meta Checkout
          # ==============================
          cd susfs4ksu

          if [ -n "${{ github.event.inputs.SUSFS-META }}" ]; then
            if [[ "${{ github.event.inputs.SUSFS-META }}" =~ ^[0-9]+$ ]]; then
              git checkout HEAD~${{ github.event.inputs.SUSFS-META }}
            else
              git checkout "${{ github.event.inputs.SUSFS-META }}"
            fi
          fi

          cd ..

          # ==============================
          # Detect SUSFS Patch File
          # ==============================
          SUS_PATCH=$(ls ./susfs4ksu/kernel_patches/50_add_susfs_in_gki-${{ env.ANDROID-VERSION }}-${{ env.KERNEL_VERSION }}*.patch 2>/dev/null | head -n1)

          if [ -z "$SUS_PATCH" ]; then
            echo "ERROR: SUSFS Patch Not Found for $GKI-OKI-VERSION"
            echo "Available Patches:"
            ls ./susfs4ksu/kernel_patches/ || true
            exit 1
          fi

          echo "Using SUSFS Patch: $SUS_PATCH"

          # ==============================
          # Copy Patch + Source Files
          # ==============================
          cp "$SUS_PATCH" $KDIR/
          cp -r ./susfs4ksu/kernel_patches/fs/* $KDIR/fs/
          cp -r ./susfs4ksu/kernel_patches/include/linux/* $KDIR/include/linux/

          cd $KDIR

          # ==============================
          # Apply SUSFS Patch
          # ==============================
          patch -p1 < "$(basename $SUS_PATCH)" || true
          echo "✅ 50 Enable SUSFS Patch Applied!"

          # ==============================
          # Hide Patch (Only Supported Bases)
          # ==============================
          if [[ "$GKI-OKI-VERSION" == "android14-6.1" || \
                "$GKI-OKI-VERSION" == "android15-6.1" || \
                "$GKI-OKI-VERSION" == "android15-6.6" ]]; then

              echo "Applying Hide Patch"

              wget -q https://raw.githubusercontent.com/AndreiMikh/AndreiMikh-Kernel-Lab/LiquidAndrei/patches/69_hide_stuff.patch \
                -O 69_hide_stuff.patch

              patch -p1 -N -F 3 < 69_hide_stuff.patch || true
              echo "✅ Hide Patch Applied!"
          else
            echo "❌ Skipping Hide Patch (Unsupported Base)"
          fi

          # ==============================
          # Apply KernelSU 10 Enable SUSFS Patch
          # ==============================
          if [[ "${{ github.event.inputs.KSU-META }}" == "KernelSU" ]]; then          
              echo "KernelSU Type Detected, Preparing SUSFS Enable Patch..."
          
              if [[ "${{ github.event.inputs.SUSFS-VERSION }}" == "OGKI" ]]; then
                  PATCH_URL="https://raw.githubusercontent.com/cctv18/susfs4oki/oki-${{ env.ANDROID-VERSION }}-${{ env.KERNEL_VERSION }}/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch"
              else
                  PATCH_URL="https://gitlab.com/simonpunk/susfs4ksu/-/raw/gki-${{ env.ANDROID-VERSION }}-${{ env.KERNEL_VERSION }}/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch"
              fi
          
              echo "Downloading from: $PATCH_URL"
          
              wget -q "$PATCH_URL" -O enable_susfs.patch || true
          
              if [[ -f "enable_susfs.patch" ]]; then
                  echo "Applying Patch Inside $KDIR"
          
                  patch -d "$KDIR" -p1 --forward < enable_susfs.patch || true
          
                  rm -f enable_susfs.patch
          
                  echo "✅ 10 Enable SUSFS Patch Applied!"
              else
                  echo "⚠️ Patch Not Found, Skipping"
              fi
          else
              echo "❌ KernelSU Not Selected, Skipping SUSFS Enable Patch"
          fi

          cd - >/dev/null

          echo "SUSFS Applied Successfully"        
          
          # ==============================
          # Pull ZRAM Patches
          # ==============================
          if [[ "${{ github.event.inputs.ZRAM }}" == 1* ]]; then
            echo "Pulling ZRAM Patches..."

            SRC_BASE="../SukiSU_patch/other/zram"
            DEST_BASE="./common"

            # Copy Headers
            if [[ -d "$SRC_BASE/lz4k/include/linux" ]]; then
              cp -r "$SRC_BASE/lz4k/include/linux/" "$DEST_BASE/include/linux/"
              echo "✅ Copied Linux Headers"
            fi

            # Copy Lib Files
            if [[ -d "$SRC_BASE/lz4k/lib" ]]; then
              cp -r "$SRC_BASE/lz4k/lib/" "$DEST_BASE/lib/"
              echo "✅ Copied Lib Files"
            fi

            # Copy Crypto Files
            if [[ -d "$SRC_BASE/lz4k/crypto" ]]; then
              cp -r "$SRC_BASE/lz4k/crypto/" "$DEST_BASE/crypto/"
              echo "✅ Copied Crypto Files"
            fi

            # Copy OPlus-Specific Lib
            if [[ -d "$SRC_BASE/lz4k_oplus" ]]; then
              cp -r "$SRC_BASE/lz4k_oplus/" "$DEST_BASE/lib/"
              echo "✅ Copied LZ4K OPlus Files"
            fi

            echo "✅ All ZRAM Patches Applied"
          fi
          
          cd ./kernel_platform/common

          GKI-OKI-VERSION="${{ env.ANDROID-VERSION }}-${{ env.KERNEL_VERSION }}"
          SUBLEVEL=$(grep '^SUBLEVEL *=' Makefile | head -n1 | cut -d= -f2 | tr -d ' ')

          # ==============================
          # 5.15 Legacy C Library Compatibility Fix
          # ==============================
          if [ "$GKI-OKI-VERSION" == "android13-5.15" ] && [ "$SUBLEVEL" -lt 123 ]; then
            echo "Apply Legacy Fix for Kernel 5.15.0–5.15.123 (Old Libc Compatibility Issue)"

            cp ../../AndreiMikh-Kernel-Lab/patches/Legacy-5.15-Fix ./Legacy-5.15-Fix.patch
            patch -p1 < Legacy-5.15-Fix.patch

            echo "5.15 Legacy Fix Applied Successfully"
          fi

          # ==============================
          # 6.6.0–6.6.30 TrustyOS Missing Fix
          # ==============================
          if [[ "${{ env.KV2 }}" == "66" && "${{ env.KV3 }}" -le 6630 && "${{ github.event.inputs.SUSFS-META }}" != "-1" ]]; then
            TRUSTY_EXISTS="false"

            # Check if TrustyOS Exist in the Manifest
            if grep -q 'common-modules/trusty' "$GITHUB_WORKSPACE/.repo/manifests_fallback/${FILE}.xml"; then
              TRUSTY_EXISTS="true"
            fi

            echo "trusty_exists=$TRUSTY_EXISTS" >> $GITHUB_OUTPUT

            # If TrustyOS is Missing, Fix the TrustyOS Issue
            if [[ "$TRUSTY_EXISTS" == "false" ]]; then
              echo "Fixing Missing TrustyOS in 6.6.0–6.6.30 Kernel Source & Manifest (SUSFS Error Fix)"

              # Update the Patch to Fix TrustyOS Issues
              sed -i 's/-32,12 +32,38/-32,11 +32,37/g' 50_add_susfs_in_gki-${{ env.ANDROID-VERSION }}-${{ env.KERNEL_VERSION }}.patch
              sed -i '/#include <trace\/hooks\/fs.h>/d' 50_add_susfs_in_gki-${{ env.ANDROID-VERSION }}-${{ env.KERNEL_VERSION }}.patch
            fi
          fi

          if [ "${{ github.event.inputs.SUSFS-META }}" != "-1" ]; then

            # ==============================
            # Fake Patch Workaround to Prevent Patch Failures
            # ==============================
            fake_patched=0

            # Apply Fake Patch for Specific Android Versions
            if [ "$GKI-OKI-VERSION" = "android15-6.6" ]; then
              if ! grep -qxF $'\tunsigned int nr_subpages = __PAGE_SIZE / PAGE_SIZE;' ./fs/proc/task_mmu.c; then
                echo "NR Subpages Not Found, Apply Temporary Fix"

                sed -i \
                  -e '/int ret = 0, copied = 0;/a \\tunsigned int nr_subpages \= __PAGE_SIZE \/ PAGE_SIZE;' \
                  -e '/int ret = 0, copied = 0;/a \\tpagemap_entry_t \*res = NULL;' \
                  ./fs/proc/task_mmu.c

                fake_patched=1
              fi
            fi

            # Handle Other Android Versions
            if [ "$GKI-OKI-VERSION" = "android14-6.1" ]; then
              if ! grep -qxF $'\tif (!vma_pages(vma))' ./fs/proc/task_mmu.c; then
                echo "VMA Pages Not Found, Apply Temporary Fix"
                fake_patched=1
              fi

              if ! grep -qxF '#include <linux/dma-buf.h>' ./fs/proc/base.c; then
                echo "Missing #include <linux/dma-buf.h>, Adding Header"

                sed -i '/#include <linux\/cpufreq_times.h>/a #include <linux\/dma-buf.h>' ./fs/proc/base.c
              fi
            fi

            # Handle Android 12 / 13 Versions
            if [ "$GKI-OKI-VERSION" = "android12-5.10" ] || [ "$GKI-OKI-VERSION" = "android13-5.15" ]; then
              if ! grep -qxF $'\tif (!vma_pages(vma))' ./fs/proc/task_mmu.c; then
                echo "VMA Pages Not Found, Apply Temporary Fix"
                fake_patched=1
              fi
            fi

            # ==============================
            # Revert Temporary Fake Patch
            # ==============================
            if [ "$fake_patched" = 1 ]; then

              # Revert Fake Patches Based on Kernel Version
              if [ "$GKI-OKI-VERSION" = "android15-6.6" ]; then
                if grep -qxF $'\tunsigned int nr_subpages = __PAGE_SIZE / PAGE_SIZE;' ./fs/proc/task_mmu.c; then
                  sed -i \
                    -e '/unsigned int nr_subpages \= __PAGE_SIZE \/ PAGE_SIZE;/d' \
                    -e '/pagemap_entry_t \*res = NULL;/d' \
                    ./fs/proc/task_mmu.c
                fi
              fi

              if [ "$GKI-OKI-VERSION" = "android12-5.10" ] || \
                 [ "$GKI-OKI-VERSION" = "android13-5.15" ] || \
                 [ "$GKI-OKI-VERSION" = "android14-6.1" ]; then

                if grep -qxF $'\t\tgoto show_pad;' ./fs/proc/task_mmu.c; then
                  sed -i -e 's/goto show_pad;/return 0;/' ./fs/proc/task_mmu.c
                fi
              fi
            fi

            # ==============================
            # Optional XUS fix
            # ==============================
            if [ "${{ github.event.inputs.SUSFS-META }}" != "-1" ] && \
               [ "${{ github.event.inputs.XUS-ERROR-FIX }}" = "true" ]; then

              cp ../../AndreiMikh-Kernel-Lab/patches/XUS-Fix.patch ./
              patch -p1 < XUS-Fix.patch || true
            fi
          fi        
            
      - name: Apply Conversion
        if: ${{ env.KERNEL_VERSION == '6.6' && github.event.inputs.FENGCHI == 'false' }}
        run: |
          PATCH_DIR="${GITHUB_WORKSPACE}/kernel_workspace/AndreiMikh-Kernel-Lab/patches"

          cd kernel_workspace/kernel_platform/common

          # ==============================
          # If it Already Exists, Skip
          # ==============================
          for p in ./kernel/sched/hmbird* ./vendor/oplus/kernel/cpu/sched_ext/hmbird*; do
            [ -d "$p" ] && {
              echo "HMBIRD Source Already Exists, Skipping Conversion"
              exit 0
            }
          done

          sed -i '1iobj-y += hmbird_patch.o' drivers/Makefile

          echo "Applying OGKI → GKI Conversion Patch"
          patch -p1 -F 3 < "${PATCH_DIR}/HMBIRD.patch" || true

          echo "Conversion Completed"
      
      - name: Unicode Bypass
        if: ${{ github.event.inputs.UNICODE-BYPASS == 'true' }}
        run: |
          set -euo pipefail

          PATCH_DIR="${GITHUB_WORKSPACE}/kernel_workspace/AndreiMikh-Kernel-Lab/patches"

          cd kernel_workspace/kernel_platform/common || exit 1

          if [ "$KV1" -lt 6 ]; then
            patch -p1 --forward < "${PATCH_DIR}/Unicode-Bypass-Fix-6.1-.patch" || true
          else
            patch -p1 --forward < "${PATCH_DIR}/Unicode-Bypass-Fix-6.1+.patch" || true
          fi

      - name: ZRAM
        if: startsWith(github.event.inputs.ZRAM, '1/')
        run: |
          set -euo pipefail

          ZRAM="${{ github.event.inputs.ZRAM }}"

          # ==============================
          # Count "/" safely
          # ==============================
          SLASH_COUNT=$(echo "$ZRAM" | tr -cd '/' | wc -c)

          if [ "$SLASH_COUNT" -lt 2 ]; then
            echo "Error: ZRAM Parameter Format Must be:"
            echo "Switch(0/1)/Algorithm/Size"
            exit 10
          fi

          # ==============================
          # Parse Fields
          # ==============================
          IFS='/' read -r ZRAM_SWSTA ZRAM_ALGO ZRAM_SIZE <<< "$ZRAM"

          echo "ZRAM_ALGO=$ZRAM_ALGO" >> "$GITHUB_ENV"
          echo "ZRAM_ALGO_U=$(echo "$ZRAM_ALGO" | tr '[:lower:]' '[:upper:]')" >> "$GITHUB_ENV"
          echo "ZRAM_SIZE=$ZRAM_SIZE" >> "$GITHUB_ENV"

          PATCH_DIR="${GITHUB_WORKSPACE}/kernel_workspace/SukiSU_patch/other/zram/zram_patch/${KERNEL_VERSION}"

          cd kernel_workspace/kernel_platform/common || exit 1

          echo "Applying LZ4KD Patches..."
          patch -p1 -F 3 < "${PATCH_DIR}/lz4kd.patch" || true
          echo "LZ4KD Patches Complete"

          echo "Applying LZ4K Patches..."
          patch -p1 -F 3 < "${PATCH_DIR}/lz4k_oplus.patch" || true
          echo "LZ4K Patches Complete"

      - name: Fengchi (SM-8750)
        if: ${{ github.event.inputs.FENGCHI == 'true' }}
        env:
          FILE: ${{ github.event.inputs.FILE }}
        run: |
          set -euo pipefail

          cd kernel_workspace/kernel_platform/common || exit 1

          # ==============================
          # Check if Fengchi Already Exists
          # ==============================
          for p in ./kernel/sched/hmbird* ./vendor/oplus/kernel/cpu/sched_ext/hmbird*; do
            if [ -d "$p" ]; then
              echo "Fengchi Code Already Exists, Skipping"
              exit 0
            fi
          done

          if [ -z "${CPU:-}" ]; then
            echo "CPU Branch Not Specified"
            exit 11
          fi

          git clone https://github.com/AndreiMikh/Kernel-Hmbird-Patch.git -b "$CPU" || {
            echo "CPU Branch Does Not Exist"
            exit 11
          }

          PATCH_FILE="fengchi_${FILE}.patch"

          if [ ! -f "./Kernel-Hmbird-Patch/${PATCH_FILE}" ]; then
            echo "Patch File Not Found"
            exit 12
          fi

          cp "./Kernel-Hmbird-Patch/${PATCH_FILE}" ./

          echo "Applying Patch..."
          dos2unix "${PATCH_FILE}" || true
          patch -p1 -F 3 < "${PATCH_FILE}"
          echo "Patch Complete"

      - name: Adaptive I/O Scheduler
        if: ${{ github.event.inputs.ADIOS == 'true' }}
        run: |
          set -euo pipefail
          cd kernel_workspace/kernel_platform/common || exit 1

          # Detect DefConfig Path
          if [[ -f ../common/arch/arm64/configs/gki_defconfig ]]; then
            DEFCONFIG="../common/arch/arm64/configs/gki_defconfig"
          elif [[ -f ../arch/arm64/configs/gki_defconfig ]]; then
            DEFCONFIG="../arch/arm64/configs/gki_defconfig"
          else
            echo "GKI DefConfig Not Found!"
            exit 1
          fi

          # Check if Adaptive I/O Scheduler Source Exists
          if [[ ! -f ../drivers/block/mq-iosched/adios-iosched.c ]]; then
            echo "⚠ Adaptive I/O Scheduler Source Not Found, Skipping Adaptive IO Scheduler Configuration"
            exit 0
          fi

          # Remove Old Adaptive I/O Scheduler Entries to Prevent Duplication
          sed -i '/CONFIG_MQ_IOSCHED_ADIOS/d' "$DEFCONFIG"
          sed -i '/CONFIG_MQ_IOSCHED_DEFAULT_ADIOS/d' "$DEFCONFIG"

          # Enable Adaptive I/O Scheduler
          echo "CONFIG_MQ_IOSCHED_ADIOS=y" >> "$DEFCONFIG"
          echo "CONFIG_MQ_IOSCHED_DEFAULT_ADIOS=y" >> "$DEFCONFIG"

          echo "✅ Adaptive I/O Scheduler Enabled in $DEFCONFIG"

      - name: LSM BBG
        if: ${{ github.event.inputs.LSM == 'true' }}
        run: |
          set -euo pipefail

          cd kernel_workspace/kernel_platform/common || exit 1

          echo "Enabling Kernel-Level Baseband Protection..."

          curl -LSs \
            https://raw.githubusercontent.com/vc-teahouse/Baseband-guard/main/setup.sh \
            | bash -s fix_blkdev_rename

          sed -i '/^config LSM$/,/^help$/{
            /^[[:space:]]*default/{
              /baseband_guard/! s/selinux/selinux,baseband_guard/
            }
          }' ./security/Kconfig

      - name: Add Configuration Settings
        run: |
          # Navigate to the Correct Directory
          cd kernel_workspace/kernel_platform/common

          # Set the Path to the Configuration File
          CONFIG_FILE=./arch/arm64/configs/gki_defconfig

          # Get the Kernel Version & Manager Branch from Environment Variables & GitHub Actions
          KERNEL_VERSION="${{ env.KERNEL_VERSION }}"
          MANAGER_BRANCH="${{ steps.manager.outputs.MANAGER_BRANCH }}"

          # ==============================
          # KSU Meta Configuration
          # ==============================
          echo "CONFIG_KSU=y" >> "$CONFIG_FILE"  # Enable KernelSU Support

          # Check if KSU Meta is Either SukiSU-Ultra or ReSukiSU
          if [[ "$KSU-META" == "SukiSU-Ultra" || "$KSU-META" == "ReSukiSU" ]]; then
            # Enable Multi-Manager Support if the Condition is True
            echo "CONFIG_KSU_MULTI_MANAGER_SUPPORT=y" >> "$CONFIG_FILE"
            echo "Multi-Manager Support Enabled for $KSU-META"
          else
             echo "Multi-Manager Support Not Enabled, as KSU Meta is Neither SukiSU-Ultra nor ReSukiSU"
          fi

          # ==============================
          # KPM Configuration
          # ==============================
          # Check if KPM input is "KPN" or "None", disable KPM
          if [ "${{ github.event.inputs.KPM }}" = "KPN" ] || [ "${{ github.event.inputs.KPM }}" = "None" ]; then
            echo "CONFIG_KPM=n" >> "$CONFIG_FILE"
            echo "KPM is disabled (KPN or None)."
          fi

          # Check if KPM Input is "KPM", Enable KPM
          if [ "${{ github.event.inputs.KPM }}" = "KPM" ]; then
            echo "CONFIG_KPM=y" >> "$CONFIG_FILE"
            echo "KPM is Enabled"
          fi

          # ==============================
          # Apply SUSFS Configuration
          # ==============================
          if [[ "$SUSFS-META" != "-1" ]]; then

            # Full vs Minimal SUSFS
            if [[ "$GKI-OKI-VERSION" == "android14-6.1" || \
                  "$GKI-OKI-VERSION" == "android15-6.6" || \
                  "$GKI-OKI-VERSION" == "android16-6.12" ]]; then
              SUSFS_CONFIG="FULL"
              echo "✅ Supported GKI Version Detected: $GKI-OKI-VERSION → Using FULL SUSFS"
            else
              SUSFS_CONFIG="MINIMAL"
              echo "⚠ Unsupported GKI Version: $GKI-OKI-VERSION → Using Minimal SUSFS"
            fi

            # Base SUSFS Settings (Common)
            cat >> "$CONFIG_FILE" << EOF
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MAP=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_ENABLE_LOG=y
          CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y
          CONFIG_KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          EOF

            # Full SUSFS Additional Settings
            if [[ "$SUSFS_CONFIG" == "FULL" ]]; then
              cat >> "$CONFIG_FILE" << EOF
          CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT=y
          CONFIG_KSU_SUSFS_TRY_UMOUNT=y
          CONFIG_KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT=y
          EOF
            fi

          else
          
            # SUSFS Disabled
            echo "❌ SUSFS Meta Disabled"
            echo "CONFIG_KSU_SUSFS=n" >> "$CONFIG_FILE"
          fi
          
          # ==============================
          # TMPFS Configuration (Mountify)
          # ==============================
          echo "Applying TMPFS Configuration..."

          cat >> "$CONFIG_FILE" << EOF
          CONFIG_TMPFS_XATTR=y
          CONFIG_TMPFS_POSIX_ACL=y
          EOF

          echo "✅ TMPFS Configuration Applied"

          # ==============================
          # BBR & ECN Configuration
          # ==============================
          if [[ "${{ github.event.inputs.BBR-ECN }}" == "true" ]]; then
            echo "Enabling BBR Congestion Control & ECN Features..."

            cat >> "$CONFIG_FILE" << EOF
          CONFIG_TCP_CONG_ADVANCED=y
          CONFIG_TCP_CONG_BBR=y
          CONFIG_NET_SCH_FQ=y
          CONFIG_TCP_CONG_BIC=n
          CONFIG_TCP_CONG_WESTWOOD=n
          CONFIG_TCP_CONG_HTCP=n
          CONFIG_IP_ECN=y
          CONFIG_TCP_ECN=y
          CONFIG_IPV6_ECN=y
          CONFIG_IP_NF_TARGET_ECN=y
          EOF

            echo "✅ BBR & ECN Configuration Applied"
          fi

          # ==============================
          # ZRAM Configuration
          # ==============================
          if [[ "${{ github.event.inputs.ZRAM }}" == 1* ]]; then
            echo "Enabling ZRAM-Related Kernel Options..."

            cat >> "$CONFIG_FILE" << EOF
          CONFIG_CRYPTO_LZ4HC=y
          CONFIG_CRYPTO_LZ4K=y
          CONFIG_CRYPTO_LZ4KD=y
          CONFIG_CRYPTO_842=y
          CONFIG_CRYPTO_LZ4K_OPLUS=y
          CONFIG_ZRAM_WRITEBACK=y
          EOF

            echo "✅ ZRAM Configuration Applied"
          fi
          
          # ==============================
          # LSM BBG Configuration
          # ==============================
          if [ "${{ github.event.inputs.LSM }}" = "true" ]; then
            echo "CONFIG_BBG=y" >> "$CONFIG_FILE"
          fi

          # ==============================
          # IPSET & IPV6 NAT Configuration
          # ==============================
          if [[ "${CPU}" == sm* && "${{ github.event.inputs.NETFILTER }}" == "true" ]]; then

            # BPF Stream Parser for Non-6.12 Kernels
            if [[ "$KERNEL_VERSION" != "6.12" ]]; then
              echo "CONFIG_BPF_STREAM_PARSER=y" >> "$CONFIG_FILE"
            fi

            # NETFILTER & IPSET Core Config
            cat >> "$CONFIG_FILE" << EOF
          CONFIG_NETFILTER_XT_MATCH_ADDRTYPE=y
          CONFIG_NETFILTER_XT_SET=y
          CONFIG_IP_SET=y
          CONFIG_IP_SET_MAX=65534
          CONFIG_IP_SET_BITMAP_IP=y
          CONFIG_IP_SET_BITMAP_IPMAC=y
          CONFIG_IP_SET_BITMAP_PORT=y
          CONFIG_IP_SET_HASH_IP=y
          CONFIG_IP_SET_HASH_IPMARK=y
          CONFIG_IP_SET_HASH_IPPORT=y
          CONFIG_IP_SET_HASH_IPPORTIP=y
          CONFIG_IP_SET_HASH_IPPORTNET=y
          CONFIG_IP_SET_HASH_IPMAC=y
          CONFIG_IP_SET_HASH_MAC=y
          CONFIG_IP_SET_HASH_NETPORTNET=y
          CONFIG_IP_SET_HASH_NET=y
          CONFIG_IP_SET_HASH_NETNET=y
          CONFIG_IP_SET_HASH_NETPORT=y
          CONFIG_IP_SET_HASH_NETIFACE=y
          CONFIG_IP_SET_LIST_SET=y
          CONFIG_IP6_NF_NAT=y
          CONFIG_IP6_NF_TARGET_MASQUERADE=y
          EOF

          fi

          # ==============================
          # Apply Build Issues Fix
          # ==============================
          # Disable BTF Debug info for MTK 6.1 Kernels
          if [[ "$KERNEL_VERSION" == "6.1" && "$CPU" == mt* ]]; then
            echo "CONFIG_DEBUG_INFO_BTF=n" >> "$CONFIG_FILE"
          fi

          # ==============================
          # Enable Rust Support if Requested
          # ==============================
          if [[ "$ENABLE_RUST" == "true" ]]; then
            cat >> "$CONFIG_FILE" << EOF
          CONFIG_RUST=y
          CONFIG_ANDROID_BINDER_IPC_RUST=m
          EOF
          fi
  
          # ==============================
          # Remove Build Review
          # ==============================         
          sed -i 's/check_defconfig//' ./build.config.gki

      - name: Fix IPv6 NAT Error
        if: ${{ github.event.inputs.NETFILTER == 'true' }}
        run: |
          set -euxo pipefail

          PATCH_DIR="${GITHUB_WORKSPACE}/kernel_workspace/AndreiMikh-Kernel-Lab/patches"
          TARGET_DIR="${GITHUB_WORKSPACE}/kernel_workspace/kernel_platform/common"
          PATCH_FILE="${PATCH_DIR}/IPv6.patch"

          echo "NETFILTER Enabled — Checking IPv6 NAT Compatibility..."

          # ==============================
          # Ensure Target Directory Exists
          # ==============================
          if [[ ! -d "$TARGET_DIR" ]]; then
            echo "❌ Target Directory Not Found: $TARGET_DIR"
            exit 1
          fi

          cd "$TARGET_DIR"

          # ==============================
          # Only Apply on Supported CPU
          # ==============================
          if [[ "${CPU:-}" == sm* ]]; then
            echo "Applying IPv6 NAT Compatibility Fix..."

            if [[ ! -f "$PATCH_FILE" ]]; then
              echo "❌ Patch File Not Found: $PATCH_FILE"
              exit 1
            fi

            # Apply Patch with Fuzz Factor 3
            patch -p1 -F 3 < "$PATCH_FILE"

            echo "✅ IPv6 NAT Fix Applied Successfully"
          else
            echo "⚠ Device Does Not Support IPv6 NAT — Skipping"
          fi

      - name: Custom Build Time
        shell: bash
        run: |  
          # ==============================
          # Determine Build Timestamp
          # ==============================
          INPUT_TIME="${{ github.event.inputs.BUILDTIME }}"
          if [[ -n "$INPUT_TIME" && "$INPUT_TIME" != "F" && "$INPUT_TIME" != "f" ]]; then
            DATESTR="$INPUT_TIME"
            echo "Using Input Build Time: $DATESTR"
          else
            DATESTR="$(TZ='UTC' date +'%a %b %d %T %Z %Y')"
            echo "Using UTC Time as Fallback: $DATESTR"
          fi

          # ==============================
          # Export Build Environment Variables
          # ==============================
          echo "KBUILD-BUILD-TIMESTAMP=${DATESTR}" >> "$GITHUB_ENV"
          echo "KBUILD-BUILD-VERSION=1" >> "$GITHUB_ENV"

          cd kernel_workspace/kernel_platform/

          # ==============================
          # Patch MKCompile_h Scripts
          # ==============================
          for UTC in common/scripts/mkcompile_h msm-kernel/scripts/mkcompile_h; do
            if [[ -f "$UTC" ]]; then
              echo "Patching MKCompile_h Script: $UTC with Build Time=$DATESTR"

              # If UTS Version Exists, Replace it
              if grep -q 'UTS_VERSION=' "$UTC"; then
                perl -pi -e "s{UTS_VERSION=\"\\\$\\(.*?\\)\"}{UTS_VERSION=\"#1 SMP PREEMPT $DATESTR\"}" "$UTC"
              else

                # Otherwise, Inject UTS Version Definition Safely
                perl -0777 -pi -e "s{cat <<EOF}{cat <<EOF\n#undef UTS_VERSION\n#define UTS_VERSION \"#1 SMP PREEMPT $DATESTR\" } unless /UTS_VERSION/" "$UTC"
              fi

            else
              echo "⚠ Script Not Found: $UTC — Skipping"
            fi
          done

      - name: Disable GPUEB
        if: ${{ env.KERNEL_VERSION == '5.10' && startsWith(env.CPU, 'mt') }}
        run: |
          # ============================== 
          # Disable GPUEB for MTK Kernel 5.10
          # ============================== 
          GPUEB_MAKEFILE="kernel_workspace/kernel-5.10/drivers/gpu/mediatek/Makefile"

          if [[ -f "$GPUEB_MAKEFILE" ]]; then
            echo "Disabling GPUEB in $GPUEB_MAKEFILE"
            sed -i '/obj-y.*gpueb/d' "$GPUEB_MAKEFILE"
            echo "✅ GPUEB Disabled Successfully"
          else
            echo "⚠ Makefile Not Found: $GPUEB_MAKEFILE — Skipping GPUEB Disable"
          fi
      
      - name: Build Kernel (Fast)
        if: ${{ github.event.inputs.FASTBUILD == 'true' }}
        id: fastbuild
        run: |
          KERNEL_VERSION="${{ env.KERNEL_VERSION }}"
          cd kernel_workspace/kernel_platform

          # ==============================
          # Automatic Detection of LLVM IAS
          # ==============================                   
          if [[ -f ./common/build.config.arm ]] && grep -q '^LLVM_IAS=1' ./common/build.config.arm; then
            USE_LLVM_IAS=true
          else
            USE_LLVM_IAS=false
          fi

          # ==============================
          # Read Clang Prebuilt Bin from Build Config Common
          # ==============================
          CLANG_PREBUILT_BIN=""
          for f in ./common/build.config.common ./"$KERNEL_REPOS"/build.config.common; do
            [[ -f "$f" ]] || continue
            CLANG_PREBUILT_BIN=$(grep '^CLANG_PREBUILT_BIN=' "$f" | cut -d'=' -f2)
            [[ -n "$CLANG_PREBUILT_BIN" ]] && break
          done
          if [[ -z "$CLANG_PREBUILT_BIN" ]]; then
            echo "Clang Prebuilt Bin was Not Found in build.config.common, Revert to Official Build Script"
            echo "fallback=true" >> "$GITHUB_OUTPUT"
            echo "Consider Disabling Fast Kernel Build & Submit an Issue"
            exit 0
          fi

          # ==============================
          # Try Extract Clang Version from Clang Prebuilt Bin
          # ==============================
          if [[ "$CLANG_PREBUILT_BIN" =~ (clang-r[0-9a-z]+) ]]; then
            CLANG_VERSION="${BASH_REMATCH[1]}"
          else
          
            # If No Match Found, Try Extract from Build Config Constants
            if [[ -f ./common/build.config.constants ]]; then
              CLANG_VERSION=$(grep '^CLANG_VERSION=' ./common/build.config.constants | cut -d'=' -f2 || true)
            fi
          fi

          if [[ -z "$CLANG_VERSION" ]]; then
            echo "Unable to Obtain Clang Version from Clang Prebuilt Bin or Build Config Constants; Reverting to Official Build Script"
            echo "fallback=true" >> "$GITHUB_OUTPUT"
            echo "Consider Disabling Fast Kernel Build & Submit an Issue"
            exit 0
          fi

          # ==============================
          # Replace with New Clang Version Value
          # ==============================
          CLANG_PREBUILT_BIN=${CLANG_PREBUILT_BIN/\$\{CLANG_VERSION\}/$CLANG_VERSION}
         
          # ==============================
          # Get First Directory Name of Clang Prebuilt Bin & Assign it to Clang Dir
          # ==============================
          CLANG_DIR=$(echo "$CLANG_PREBUILT_BIN" | cut -d'/' -f1)
        
          # ==============================
          # Get Parent Directory Name of Clang Prebuilt Bin & Assign it to Clang Path
          # ==============================
          CLANG_PATH=$(basename "$(dirname "$CLANG_PREBUILT_BIN")")

          echo "=========================="
          echo "CLANG_VERSION=$CLANG_VERSION"
          echo "CLANG_DIR=$CLANG_DIR"
          echo "CLANG_PATH=$CLANG_PATH"
          echo "USE_LLVM_IAS=$USE_LLVM_IAS"
          echo "=========================="

          set +u
          source "$GITHUB_WORKSPACE/kernel_workspace/kernel_platform/build/kernel/_setup_env.sh" 2>/dev/null || true
          set -u

          export PATH="$GITHUB_WORKSPACE/kernel_workspace/kernel_platform/$CLANG_PREBUILT_BIN:$PATH"
          export PATH="/usr/lib/ccache:$PATH"

          if [[ "$ENABLE_RUST" == "true" ]]; then
            export BINDGEN="bindgen"
            export LIBCLANG_PATH="$GITHUB_WORKSPACE/kernel_workspace/kernel_platform/$(dirname "$CLANG_PREBUILT_BIN")/lib"
          fi

          cd ./common

          # ==============================
          # Remapping Physical Paths
          # ==============================
          MAP="-fdebug-prefix-map=${GITHUB_WORKSPACE}=."
          MPMAP="-fmacro-prefix-map=${GITHUB_WORKSPACE}=."
          FPMAP="-ffile-prefix-map=${GITHUB_WORKSPACE}=."

          MAKE_ARGS=(
            LLVM=1
            ARCH=arm64
            CROSS_COMPILE=aarch64-linux-gnu-
            CC="ccache clang"
            HOSTCC="ccache clang"
            LD=ld.lld
            HOSTLD=ld.lld
            PAHOLE=../../prebuilts/kernel-build-tools/linux-x86/bin/pahole
            KCFLAGS+="$MAP $MPMAP $FPMAP"
            KCFLAGS+=-Wno-error
            KCFLAGS+=-D__ANDROID_COMMON_KERNEL__
          )

          if [[ "$USE_LLVM_IAS" == "true" ]]; then
            MAKE_ARGS=(LLVM_IAS=1 "${MAKE_ARGS[@]}")
          fi
          if [[ "$ENABLE_RUST" == "true" ]]; then
            MAKE_ARGS=(RUSTC=../../prebuilts/rust/linux-x86/$RUSTC_VERSION/bin/rustc "${MAKE_ARGS[@]}")
          fi
          make O=out "${MAKE_ARGS[@]}" gki_defconfig
          if [[ "$KERNEL_VERSION" == "5.10" || "$KERNEL_VERSION" == "5.15" ]]; then
            echo ">> Setup LTO = thin"
            scripts/config --file out/.config -e LTO_CLANG
            scripts/config --file out/.config -e LTO_CLANG_THIN
            scripts/config --file out/.config -d LTO_CLANG_NONE
            scripts/config --file out/.config -d LTO_CLANG_FULL
          fi

          if [[ "$KERNEL_VERSION" == "6.12" ]]; then
            echo ">> Setup LTO = none"
            scripts/config --file out/.config -e LTO_CLANG
            scripts/config --file out/.config -e LTO_CLANG_NONE
            scripts/config --file out/.config -d LTO_CLANG_THIN
            scripts/config --file out/.config -d LTO_CLANG_FULL
          fi
          make O=out "${MAKE_ARGS[@]}" olddefconfig
          make -j"$(nproc --all)" O=out "${MAKE_ARGS[@]}"
          ccache -s

      - name: Fallback to Build Kernel
        if: ${{ github.event.inputs.FASTBUILD == 'false' || steps.fastbuild.outputs.fallback == 'true' }}
        run: |
          cd kernel_workspace
          if [ -f ./kernel_platform/build_with_bazel.py ]; then
            ./kernel_platform/oplus/bazel/oplus_modules_variant.sh ${{ env.CPUD }} ${{ env.BUILD_METHOD }}
            ./kernel_platform/build_with_bazel.py -t ${{ env.CPUD }} ${{ env.BUILD_METHOD }}
          else
            LTO=thin SYSTEM_DLKM_RE_SIGN=0 BUILD_SYSTEM_DLKM=0 KMI_SYMBOL_LIST_STRICT_MODE=0 \
            ./kernel_platform/oplus/build/oplus_build_kernel.sh ${{ env.CPUD }} ${{ env.BUILD_METHOD }}
          fi

      - name: Make AnyKernel3
        run: |
          git clone https://github.com/AndreiMikh/AnyKernel3 --depth=1
          rm -rf ./AnyKernel3/.git
          mkdir -p kernel_workspace/kernel_platform/out/Final-Image-Find/
          image_path=""
          if [ -d "./kernel_workspace/kernel_platform/common/out/" ]; then
            image_path=$(find "./kernel_workspace/kernel_platform/common/out/" -name "Image" | head -n 1)
            if [ -n "$image_path" ]; then
              echo "Unified Path Used by Make for Compilation Successfully Located the Image File"
            fi
          fi
          if [ -z "$image_path" ] && [ -d "./kernel_workspace/kernel_platform/out/" ]; then
            image_path=$(find "./kernel_workspace/kernel_platform/out/" -name "Image" | head -n 1)
            if [ -n "$image_path" ]; then
              echo "Image File Successfully Found After Compiling Using Official Script"
            fi
          fi
          if [ -z "$image_path" ]; then
            echo "Image File Not Found, Build Failed" >&2
            exit 1
          fi
          if [ -f "$image_path" ]; then
            echo "Image File Finally Located at: $image_path"
            cp "$image_path" ./AnyKernel3/Image
            cp "$image_path" kernel_workspace/kernel_platform/out/Final-Image-Find/Image
          fi

      - name: Patch Linux & Replace Image
        if: ${{ github.event.inputs.KPM == 'KPM' }}
        run: |
          PATCH_DIR="${GITHUB_WORKSPACE}/kernel_workspace/SukiSU_patch/kpm"
          OUT_DIR="${GITHUB_WORKSPACE}/kernel_workspace/kernel_platform/out/Final-Image-Find"
          cd "${OUT_DIR}"
          cp "${PATCH_DIR}/patch_linux" .
          chmod +x patch_linux
          ./patch_linux
          rm -f Image
          mv oImage Image
          cp Image "${GITHUB_WORKSPACE}/AnyKernel3/Image"

      - name: Download Selected KSU Manager APK
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ steps.manager.outputs.KSU_REPO }}"
          BRANCH="${{ steps.manager.outputs.MANAGER_BRANCH }}"
          ARTIFACT="${{ steps.manager.outputs.MANAGER_ARTIFACT }}"

          echo "==== KSU Manager Downloader ===="
          echo "Repository:       $REPO"
          echo "Branch:           $BRANCH"
          echo "Artifact:         $ARTIFACT"
          echo "================================="

          mkdir -p ./AnyKernel3

          # ==============================
          # Get Latest Successful Run from any Workflow
          # ==============================
          run_id=$(gh api \
            "repos/$REPO/actions/runs?branch=$BRANCH&status=success&per_page=1" \
            --jq '.workflow_runs[0].id' 2>/dev/null || echo "")

          if [[ -z "$run_id" ]]; then
            echo "No Successful Workflow Run Found"
            exit 0
          fi

          echo "Run ID: $run_id"

          artifact_url=$(gh api \
            "repos/$REPO/actions/runs/$run_id/artifacts" \
            --jq ".artifacts[] | select(.name == \"$ARTIFACT\") | .archive_download_url" \
            | head -n1)

          if [[ -z "$artifact_url" ]]; then
            echo "Artifact '$ARTIFACT' Not Found"
            exit 0
          fi

          curl -fL -H "Authorization: token $GITHUB_TOKEN" \
            -o manager.zip \
            "$artifact_url"

          unzip -o -j manager.zip "*.apk" -d ./AnyKernel3/
          rm -f manager.zip

          echo "KSU Manager Artifact Download Complete"
          
      - name: Set Zip Suffix
        id: suffix
        run: |
          echo "value=${{ env.ZRAM_ALGO_U && format('_{0}', env.ZRAM_ALGO_U) || '' }}${{ github.event.inputs.KPM == 'KPM' && '-KPM' || github.event.inputs.KPM == 'KPN' && '-KPN' || '' }}${{ github.event.inputs.LSM == 'true' && '-BBG' || '' }}-ILH${{ github.event.inputs.FENGCHI== 'true' && '-Fengchi' || '' }}" >> $GITHUB_OUTPUT

      # Upload AnyKernel3 Artifact
      - name: Upload AnyKernel3
        uses: actions/upload-artifact@v4
        with:
          name: "${{ steps.extract_info.outputs.value }}(${{ env.TKERNEL_VERSION }})-${{ github.event.inputs.KSU-META-SOURCE }}(${{ env.KSU-META-VER }})"
          path: ./AnyKernel3/*
          
      - name: Extract & Process ZRAM Module
        if: startsWith(github.event.inputs.ZRAM, '1/')
        id: zram_find
        run: |
          set -e
          ZRAM_ZIP="${GITHUB_WORKSPACE}/kernel_workspace/AndreiMikh-Kernel-Lab/ZRAM.zip"

          if [ ! -f "$ZRAM_ZIP" ]; then
            echo "Not Found, ZRAM.zip: $ZRAM_ZIP"
            echo "upload=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          unzip "$ZRAM_ZIP" -d ZRAM-Module

          CONFIG_PROP="ZRAM-Module/config.prop"
          if [ -f "$CONFIG_PROP" ]; then
            echo "Revise config.prop"
            sed -i "s/^ZRAM_ALGO=.*/ZRAM_ALGO=${ZRAM_ALGO}/" "$CONFIG_PROP"
            sed -i "s/^ZRAM_SIZE=.*/ZRAM_SIZE=${ZRAM_SIZE}/" "$CONFIG_PROP"
            echo "ZRAM_ALGO=${ZRAM_ALGO}"
            echo "ZRAM_SIZE=${ZRAM_SIZE}"
          else
            echo "Not Found Config Prop"
            echo "upload=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          target="./ZRAM-Module/zram/zram.ko"
          echo "Find ZRAM.ko Module File..."
          search_paths=(
            "./kernel_workspace/kernel_platform/out"
            "./kernel_workspace/device/qcom"
          )
          zram_path=""
          for path in "${search_paths[@]}"; do
            if [ -d "$path" ]; then
              zram_path=$(find "$path" -type f -name "zram.ko" | head -n 1)
              [ -n "$zram_path" ] && break
            fi
          done
          if [ -z "$zram_path" ]; then
            zram_path=$(find "./kernel_workspace" -type f -name "zram.ko" | head -n 1)
          fi
          if [ -n "$zram_path" ] && [ -f "$zram_path" ]; then
            echo "ZRAM.ko File Finally Located at: $zram_path"
            install -D "$zram_path" "$target"
          else
            echo "ZRAM.ko File was Not Found, Possibly Due to an Unsupported Kernel Version or Build Failure"
            echo "upload=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

      - name: Upload ZRAM Module
        if: startsWith(github.event.inputs.ZRAM, '1/') && steps.zram_find.outputs.upload != 'false'
        uses: actions/upload-artifact@v4
        with:
          name: ZRAM-${{ env.KERNEL_VERSION }}_${{ steps.extract_info.outputs.value }}
          path: ZRAM-Module/*

      - name: Post-build Disk Check
        run: df -h
