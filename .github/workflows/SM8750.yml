name: Multi-Builder (SM8750)

on:
  workflow_dispatch:
    inputs:
      KSU_META:
        type: choice
        description: "KSU Meta"
        required: true
        default: "ReSukiSU"
        options:
          - ReSukiSU
          - SukiSU-Ultra
          - KernelSU-Next
          - WildKSU

      MANAGER_SOURCE:
        type: choice
        description: "KSU Meta Branch (Download Manager Artifact)"
        required: true
        default: "ReSukiSU-Main"
        options:
          - ReSukiSU-Main
          - ReSukiSU-Main-Spoofed
          - SukiSU-Ultra-Main
          - SukiSU-Main-Spoofed
          - KernelSU-Next-Dev
          - KernelSU-Next-Dev-Spoofed
          - WildKSU-Stable
          - WildKSU-Stable-Spoofed
          - WildKSU-Canary
          - WildKSU-Canary-Spoofed

permissions:
  actions: write
  contents: read

jobs:

# =========================
# Generate sm8750 Matrix
# =========================

  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
      - name: Generate sm8750 Device Matrix
        id: set-matrix
        run: |
          FILE_LIST=(
            "oneplus_13_b"
            "oneplus_13s_b"
            "oneplus_13t_b"
            "oneplus_ace5_pro_b"
            "oneplus_ace_6"
            "oneplus_pad_2_pro_b"
            "oneplus_pad_3_b"
          )

          MATRIX_JSON=$(printf '%s\n' "${FILE_LIST[@]}" | jq -R -s -c '
            split("\n")[:-1] |
            map({
              file: .,
              file_short: (sub("_[a-z]$"; "")),
              enable_sched: true
            })
          ')

          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT


# =========================
# Trigger Device Builds
# =========================

  build:
    needs: generate-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}

    steps:

      - name: Trigger Unified KSU Meta
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: Unified KSU Meta
          token: ${{ secrets.GITHUB_TOKEN }}
          inputs: |
            {
              "FILE": "${{ matrix.file }}",
              "KPM": "KPN",
              "MANAGER_SOURCE": "${{ github.event.inputs.MANAGER_SOURCE }}",
              "SUSFS_META": "",
              "KSU_META": "${{ github.event.inputs.KSU_META }}",
              "ZRAM": "0/1z4kd/8589934592",
              "BUILD_TIME": "",
              "SUFFIX": "",
              "LSM": true,
              "NETFILTER": true,
              "BBR_ECN": true,
              "SUSFS_DEV": false,
              "FAST_BUILD": true,
              "SCHED": true,
              "UNICODE_BYPASS": true,
              "XUS_FIX": true
            }

      - name: Wait for Artifact
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FILE="${{ matrix.file_short }}"
          echo "Waiting for artifact: $FILE"

          SECONDS=0
          MAX_TIME=$((35 * 60))
          sleep 600

          while (( SECONDS < MAX_TIME )); do
            ALL_ARTIFACTS=$(gh api --paginate repos/${{ github.repository }}/actions/artifacts --jq '.artifacts[].name')

            if echo "$ALL_ARTIFACTS" | grep -q "$FILE"; then
              echo "Artifact found for $FILE"
              exit 0
            fi

            sleep 300
          done

          echo "Timeout waiting for $FILE"
          exit 1


# =========================
# Package Final ZIP
# =========================

  wait-and-package:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Tools
        run: |
          sudo apt update
          sudo apt install -y gh zip unzip curl jq
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Download All Artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p all_artifacts
          ALL_ARTIFACTS=$(gh api --paginate repos/${{ github.repository }}/actions/artifacts --jq '.artifacts[].name')

          for ART in $ALL_ARTIFACTS; do
            ARTIFACT_ID=$(gh api repos/${{ github.repository }}/actions/artifacts \
              --jq ".artifacts[] | select(.name==\"$ART\") | .id")

            curl -L -H "Authorization: token $GH_TOKEN" \
              -o "all_artifacts/${ART}.zip" \
              "https://api.github.com/repos/${{ github.repository }}/actions/artifacts/${ARTIFACT_ID}/zip"
          done

      - name: Extract All ZIPs
        run: |
          mkdir -p extracted
          cd all_artifacts
          for f in *.zip; do
            unzip -oq "$f" -d ../extracted
          done

      - name: Create Final AnyKernel3 ZIP
        run: |
          cd extracted
          FINAL_NAME="All-AnyKernel3-${{ github.event.inputs.KSU_META }}-sm8750.zip"
          zip -r "../$FINAL_NAME" ./*

      - name: Upload Final ZIP
        uses: actions/upload-artifact@v4
        with:
          name: All-AnyKernel3-${{ github.event.inputs.KSU_META }}-sm8750
          path: All-AnyKernel3-${{ github.event.inputs.KSU_META }}-sm8750.zip
