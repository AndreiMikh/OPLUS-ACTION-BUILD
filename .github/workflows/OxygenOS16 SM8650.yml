name: Custom Multi-Build Trigger for SM8650

on:
  workflow_dispatch:
    inputs:

      TARGET_WORKFLOW:
        type: choice
        description: "Select Workflow to Trigger for SM8650"
        required: true
        default: Main-Build.yml
        options:
          - Main-Build.yml
          - Test-Build.yml

      KPM:
        type: choice
        description: "Kernel Module Implementation Methods"
        required: true
        default: KPN
        options:
          - KPM
          - KPN
          - None
          
      SUSFS_META:
        type: string
        description: "Rollback SUSFS (Enter Hash or Number or -1 to Turn Off)"
        required: false
        default: ""
        
      DYNAMIC_REPO:
        type: string
        description: "Dynamic Inventory Warehouse Owner"
        required: true
        default: ""
        
      BUILD_TIME:
        type: string
        description: "Custom Build Time (Input 'UTC' to Use Current UTC Time)"
        required: false
        default: "Sat Feb 14 07:17:27 UTC 2026"
        
      KSU_META:
        type: choice
        description: "KSU Meta"
        required: true
        default: ReSukiSU
        options:
         - ReSukiSU
         - SukiSU-Ultra
         - KernelSU-Next
         - WildKSU
         
      MANAGER_SOURCE:
        type: choice
        description: "KSU Meta-Branch (Download Manager Artifact)"
        required: true
        default: ReSukiSU-Main
        options:
         - ReSukiSU-Main
         - ReSukiSU-Main-Spoofed
         - SukiSU-Ultra-Main
         - SukiSU-Main-Spoofed
         - KernelSU-Next-Stable
         - KernelSU-Next-Stable-Spoofed
         - KernelSU-Next-Dev
         - KernelSU-Next-Dev-Spoofed
         - WildKSU-Stable
         - WildKSU-Stable-Spoofed
         - WildKSU-Canary
         - WildKSU-Canary-Spoofed
         
      SUSFS_VERSION:
        type: choice
        description: SUSFS for OGKI (susfs4oki) / SUSFS for GKI (susfs4ksu)
        required: true
        default: OGKI
        options:
          - OGKI
          - GKI
      
      ZRAM:
        type: string
        description: "ZRAM (0 for Off, 1 for On)/Algorithm Name/Size"
        required: true
        default: "0/lz4kd/8589934592"
        
      SUFFIX:
        type: string
        description: "Custom Kernel Suffix (Use Random String if Not Specified)"
        required: false
        default: "8-andreimikhail-4k"
        
      SUBLEVEL:
        description: "Custom Kernel Level Spoofing (Sublevel)"
        required: false
        default: ""
        
      FAST_BUILD:
        type: boolean
        description: "Enable Fast Kernel Build?"
        required: true
        default: true
        
      LSM:
        type: boolean
        description: "Enable Critical Partition Write Protection (BBG)?"
        required: true
        default: true
        
      NETFILTER:
        type: boolean
        description: "Enable Network Feature Extensions (Netfilter)?"
        required: true
        default: true
        
      BBR_ECN:
        type: boolean
        description: "Enable Network Optimization Algorithm (BBR+ECN)?"
        required: true
        default: true
        
      UNICODE_BYPASS:
        type: boolean
        description: "Add Fix for Unicode Invisible Code Point Bypass Read Vulnerability?"
        required: true
        default: true
        
      SCHED:
        type: boolean
        description: "Add Windspeed Driver v1.0 (Fengchi)?"
        required: true
        default: false
        
      XUS_FIX:
        type: boolean
        description: "Prevent Generation of 5US Error Files?"
        required: true
        default: true
        
      SUSFS_DEV:
        type: boolean
        description: "Extract SUSFS-Dev Branch?"
        required: true
        default: false
        
      SPACE_NOCLEAN:
        type: boolean
        description: "Disable Space Cleaning?"
        required: true
        default: false
        
      BUILD_NOCCACHE:
        type: boolean
        description: "Disable Ccache Update?"
        required: true
        default: false

permissions:
  actions: write
  contents: read

jobs:

# =========================
# Generate sm8750 Matrix
# =========================

  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
      - name: Generate sm8750 Device Matrix
        id: set-matrix
        run: |
          FILE_LIST=(
            "oneplus_12_b"
            "oneplus_13r_b"
            "oneplus_ace3_pro_b"
            "oneplus_ace5_b"
            "oneplus_pad2_b"
            "oneplus_pad_pro_b"
          )

          MATRIX_JSON=$(printf '%s\n' "${FILE_LIST[@]}" | jq -R -s -c '
            split("\n")[:-1] |
            map({
              file: .,
              file_short: (sub("_[a-z]$"; "")),
              enable_sched: false
            })
          ')

          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT


# =========================
# Trigger Device Builds
# =========================

  build:
    needs: generate-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}

    steps:

      - name: Trigger Selected Workflow
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: ${{ github.event.inputs.TARGET_WORKFLOW }}
          ref: refs/heads/LiquidAndrei
          token: ${{ secrets.GITHUB_TOKEN }}
          inputs: |
            {
              "FILE"             : "${{ matrix.file }}",
              "KPM"              : "${{ github.event.inputs.KPM }}",
              "MANAGER_SOURCE"   : "${{ github.event.inputs.MANAGER_SOURCE }}",
              "SUSFS_META"       : "${{ github.event.inputs.SUSFS_META }}",
              "DYNAMIC_REPO"     : "${{ github.event.inputs.DYNAMIC_REPO }}",
              "SUSFS_META"       : "${{ github.event.inputs.SUSFS_META }}",  
              "KSU_META"         : "${{ github.event.inputs.KSU_META }}",
              "ZRAM"             : "${{ github.event.inputs.ZRAM }}",
              "BUILD_TIME"       : "${{ github.event.inputs.BUILD_TIME }}",
              "SUFFIX"           : "${{ github.event.inputs.SUFFIX }}",
              "SUSFS_VERSION"    : "${{ github.event.inputs.SUSFS_VERSION }}",
              "LSM"              : "${{ github.event.inputs.LSM }}",
              "SUBLEVEL"         : "${{ github.event.inputs.SUBLEVEL }}",
              "NETFILTER"        : "${{ github.event.inputs.NETFILTER }}",
              "BBR_ECN"          : "${{ github.event.inputs.BBR_ECN }}",
              "SUSFS_DEV"        : "${{ github.event.inputs.SUSFS_DEV }}",
              "FAST_BUILD"       : "${{ github.event.inputs.FAST_BUILD }}",
              "SCHED"            : "${{ github.event.inputs.SCHED }}",
              "UNICODE_BYPASS"   : "${{ github.event.inputs.UNICODE_BYPASS }}",
              "SPACE_NOCLEAN"    : "${{ github.event.inputs.SPACE_NOCLEAN }}",
              "BUILD_NOCCACHE"   : "${{ github.event.inputs.BUILD_NOCCACHE }}",
              "XUS_FIX"          : "${{ github.event.inputs.XUS_FIX }}"
            }

      - name: Wait for Artifact
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FILE="${{ matrix.file_short }}"
          echo "Waiting for artifact: $FILE"

          SECONDS=0
          MAX_TIME=$((35 * 60))
          sleep 600

          while (( SECONDS < MAX_TIME )); do
            ARTIFACTS=$(gh api \
              repos/${{ github.repository }}/actions/artifacts \
              --jq '.artifacts[].name')

            if echo "$ARTIFACTS" | grep -q "$FILE"; then
              echo "Artifact found for $FILE"
              exit 0
            fi

            sleep 300
          done

          echo "Timeout waiting for $FILE"
          exit 1


# =========================
# Collect & Upload ZIPs (No Fusion)
# =========================

  wait-and-package:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Tools
        run: |
          sudo apt update
          sudo apt install -y gh curl jq
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Download Artifacts From Current Run Only
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p final_zips

          RUN_ID="${{ github.run_id }}"
          echo "Fetching artifacts for run ID: $RUN_ID"

          ARTIFACTS=$(gh api \
            repos/${{ github.repository }}/actions/runs/$RUN_ID/artifacts \
            --jq '.artifacts[].name')

          for ART in $ARTIFACTS; do
            echo "Downloading $ART"

            ARTIFACT_ID=$(gh api \
              repos/${{ github.repository }}/actions/runs/$RUN_ID/artifacts \
              --jq ".artifacts[] | select(.name==\"$ART\") | .id")

            curl -L \
              -H "Authorization: token $GH_TOKEN" \
              -o "final_zips/${ART}.zip" \
              "https://api.github.com/repos/${{ github.repository }}/actions/artifacts/${ARTIFACT_ID}/zip"
          done

      - name: Upload Device ZIPs (Separated)
        uses: actions/upload-artifact@v4
        with:
          name: All-AnyKernel3-${{ github.event.inputs.KSU_META }}-sm8750
          path: final_zips/*.zip
