- name: Unicode Bypass
  if: ${{ github.event.inputs.UNICODE_BYPASS == 'true' }}
  run: |
    set -euo pipefail

    PATCH_DIR="${GITHUB_WORKSPACE}/kernel_workspace/OPlus-Action-Build/patches"

    cd kernel_workspace/kernel_platform/common || exit 1

    if [ "$KV1" -lt 6 ]; then
      patch -p1 --forward < "${PATCH_DIR}/unicode_bypass_fix_6.1-.patch" || true
    else
      patch -p1 --forward < "${PATCH_DIR}/unicode_bypass_fix_6.1+.patch" || true
    fi

- name: ZRAM
  if: startsWith(github.event.inputs.ZRAM, '1/')
  run: |
    set -euo pipefail

    ZRAM="${{ github.event.inputs.ZRAM }}"

    # Count "/" safely
    SLASH_COUNT=$(echo "$ZRAM" | tr -cd '/' | wc -c)

    if [ "$SLASH_COUNT" -lt 2 ]; then
      echo "Error: ZRAM parameter format must be:"
      echo "Switch(0/1)/Algorithm/Size"
      exit 10
    fi

    # Parse fields
    IFS='/' read -r ZRAM_SWSTA ZRAM_ALGO ZRAM_SIZE <<< "$ZRAM"

    echo "ZRAM_ALGO=$ZRAM_ALGO" >> "$GITHUB_ENV"
    echo "ZRAM_ALGO_U=$(echo "$ZRAM_ALGO" | tr '[:lower:]' '[:upper:]')" >> "$GITHUB_ENV"
    echo "ZRAM_SIZE=$ZRAM_SIZE" >> "$GITHUB_ENV"

    PATCH_DIR="${GITHUB_WORKSPACE}/kernel_workspace/SukiSU_patch/other/zram/zram_patch/${KERNEL_VERSION}"

    cd kernel_workspace/kernel_platform/common || exit 1

    echo "Applying LZ4KD patches..."
    patch -p1 -F 3 < "${PATCH_DIR}/lz4kd.patch" || true
    echo "LZ4KD patches complete."

    echo "Applying LZ4K OPlus patches..."
    patch -p1 -F 3 < "${PATCH_DIR}/lz4k_oplus.patch" || true
    echo "LZ4K OPlus patches complete."

- name: Scheduler
  if: ${{ github.event.inputs.SCHED == 'true' }}
  env:
    FILE: ${{ github.event.inputs.FILE }}
  run: |
    set -euo pipefail

    cd kernel_workspace/kernel_platform/common || exit 1

    # Check if Fengchi already exists
    for p in ./kernel/sched/hmbird* ./vendor/oplus/kernel/cpu/sched_ext/hmbird*; do
      if [ -d "$p" ]; then
        echo "Fengchi code already exists. Skipping."
        exit 0
      fi
    done

    if [ -z "${CPU:-}" ]; then
      echo "❌ CPU branch not specified."
      exit 11
    fi

    git clone https://github.com/AndreiMikh/Kernel-Hmbird-Patch.git -b "$CPU" || {
      echo "❌ CPU branch does not exist."
      exit 11
    }

    PATCH_FILE="fengchi_${FILE}.patch"

    if [ ! -f "./Kernel-Hmbird-Patch/${PATCH_FILE}" ]; then
      echo "❌ Patch file not found."
      exit 12
    fi

    cp "./Kernel-Hmbird-Patch/${PATCH_FILE}" ./

    echo "Applying Windspeed patch..."
    dos2unix "${PATCH_FILE}" || true
    patch -p1 -F 3 < "${PATCH_FILE}"
    echo "Windspeed patch complete."

- name: LSM BBG
  if: ${{ github.event.inputs.LSM == 'true' }}
  run: |
    set -euo pipefail

    cd kernel_workspace/kernel_platform/common || exit 1

    echo "Enabling Kernel-Level Baseband Protection..."

    curl -LSs \
      https://raw.githubusercontent.com/vc-teahouse/Baseband-guard/fix_blkdev_rename/setup.sh \
      | bash -s fix_blkdev_rename

    sed -i '/^config LSM$/,/^help$/{
      /^[[:space:]]*default/{
        /baseband_guard/! s/selinux/selinux,baseband_guard/
      }
    }' ./security/Kconfig
